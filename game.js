/**
 * Math Jungle Adventure - Core Game Logic
 */

/* --- Mathematics Engine --- */
class ProblemGenerator {
    static generate(grade, stage) {
        let problem = {};
        const isInfinite = stage > 10;
        // Infinite mode Scaling: Every 5 stages increases difficulty index
        const difficultyScale = isInfinite ? Math.floor((stage - 11) / 5) : 0;

        if (grade === 1) {
            // Grade 1: Counting Only (수세기)
            // Stage 1-3: 1~10
            // Stage 4-7: 1~30
            // Stage 8-10: 1~50 (Skip counting)
            // Infinite: 1~100+
            let max = 10;
            if (stage > 3) max = 30;
            if (stage > 7) max = 50;
            if (isInfinite) max = 50 + (difficultyScale * 10);

            if (stage > 7 || (isInfinite && stage % 2 === 0)) {
                return this.generateSkipCounting(max); 
            }
            return this.generateCounting(max);
        } 
        else if (grade === 2) {
            // Grade 2: Add/Sub Only (덧셈/뺄셈)
            // Stage 1-3: Simple Add (Sum <= 10)
            // Stage 4-6: Simple Sub (Single digit)
            // Stage 7-8: Add (2-digit, no carry -> carry)
            // Stage 9-10: Sub (2-digit, no borrow -> borrow)
            if (stage <= 3) return this.generateAddSub(1, 5, '+'); 
            if (stage <= 6) return this.generateAddSub(1, 9, '-');
            
            // Late Grade 2 & Infinite: 2-digit calculations
            let min = 10;
            let max = 20 + (isInfinite ? difficultyScale * 10 : 0);
            
            // Mix Add/Sub for late stages
            const op = (stage <= 8 && !isInfinite) ? '+' : (stage <= 10 && !isInfinite) ? '-' : Math.random() > 0.5 ? '+' : '-';
            return this.generateAddSub(min, max, op);
        }
        else if (grade === 3) {
            // Grade 3: Multiplication Only (구구단)
            // Stage 1-3: 2~5단
            // Stage 4-7: 6~9단
            // Stage 8-10: Mixed 2~9단
            let tables = [2, 3, 4, 5];
            if (stage > 3) tables = [6, 7, 8, 9];
            if (stage > 7 || isInfinite) tables = [2, 3, 4, 5, 6, 7, 8, 9];
            
            return this.generateMultiplication(tables);
        }
        else if (grade === 4) {
             // Grade 4: Division Only (나눗셈)
             // Stage 1-4: Basic (Divisors 2-5)
             // Stage 5-8: Advanced (Divisors 6-9)
             // Stage 9-10: Random (Divisors 2-9)
             let divisors = [2, 3, 4, 5];
             if (stage > 4) divisors = [6, 7, 8, 9];
             if (stage > 8 || isInfinite) divisors = [2, 3, 4, 5, 6, 7, 8, 9];

             return this.generateDivision(divisors);
        }
        
        // Fallback
        return this.generateAddSub(1, 10, '+');
    }

    static generateCounting(max) {
        let num = Math.floor(Math.random() * (max - 3)) + 1;
        if (num < 1) num = 1;
        return {
            type: 'counting',
            desc: "다음 숫자는?",
            problem: `${num}, ${num+1}, ${num+2}, ?`,
            answer: num + 3,
            options: this.generateOptions(num + 3),
            hintData: { type: 'sequence', step: 1, start: num, values: [num, num+1, num+2] }
        };
    }

    static generateSkipCounting(max) {
        let step = Math.floor(Math.random() * 4) + 2; // 2, 3, 4, 5
        let start = Math.floor(Math.random() * (max - (step * 3))) + 1;
        if (start < 1) start = 1;
        
        let v1 = start;
        let v2 = start + step;
        let v3 = start + (step * 2);
        let answer = start + (step * 3);

        return {
            type: 'counting',
            desc: "규칙을 찾아보세요!",
            problem: `${v1}, ${v2}, ${v3}, ?`,
            answer: answer,
            options: this.generateOptions(answer),
            hintData: { type: 'sequence', step: step, start: start, values: [v1, v2, v3] }
        };
    }

    static generateAddSub(min, max, operator) {
        let a = Math.floor(Math.random() * (max - min + 1)) + min;
        let b = Math.floor(Math.random() * (max - min + 1)) + min;
        
        // Ensure result is within reasoning bounds for Grade 1/2
        if (operator === '+') {
            // Cap sum if max is small (Simple addition)
            if (max <= 10) {
                while (a + b > 10) {
                    a = Math.floor(Math.random() * (max - min + 1)) + min;
                    b = Math.floor(Math.random() * (max - min + 1)) + min;
                }
            }
        } else {
             if (a < b) [a, b] = [b, a];
        }

        const answer = operator === '+' ? a + b : a - b;
        return {
            type: 'calc',
            desc: "계산해볼까요?",
            problem: `${a} ${operator} ${b} = ?`,
            answer: answer,
            options: this.generateOptions(answer),
            hintData: { type: 'calc', v1: a, v2: b, op: operator, answer: answer }
        };
    }

    static generateMultiplication(tables) {
        const table = tables[Math.floor(Math.random() * tables.length)];
        const multiplier = Math.floor(Math.random() * 9) + 1;
        const answer = table * multiplier;
        
        return {
            type: 'calc',
            desc: "구구단을 외자!",
            problem: `${table} x ${multiplier} = ?`,
            answer: answer,
            options: this.generateOptions(answer),
            hintData: { type: 'mult', table: table, step: multiplier, answer: answer }
        };
    }

    static generateDivision(minDivisor, maxDivisor) {
        const divisor = Math.floor(Math.random() * (maxDivisor - minDivisor + 1)) + minDivisor;
        const quotient = Math.floor(Math.random() * 9) + 1;
        const dividend = divisor * quotient;
        
        return {
            type: 'calc',
            desc: "나눗셈을 해볼까요?",
            problem: `${dividend} ÷ ${divisor} = ?`,
            answer: quotient,
            options: this.generateOptions(quotient),
            hintData: { type: 'div', total: dividend, perGroup: divisor, answer: quotient }
        };
    }

    static generateMixed() {
        // Simple mixed operation: A + B x C (teaching order of operations)
        // Or just big multiplication
        return this.generateMultiplication([11, 12, 13, 14, 15]);
    }

    static generateOptions(correctAnswer) {
        const options = new Set([correctAnswer]);
        while(options.size < 4) {
            let offset = Math.floor(Math.random() * 10) - 5;
            if (offset === 0) offset = 1;
            let val = correctAnswer + offset;
            if (val < 0) val = 0; // No negative options for elementary
            options.add(val);
        }
        return Array.from(options).sort(() => Math.random() - 0.5);
    }
}

/* --- Data Definitions --- */
const CHARACTER_DEFS = {
    monkey:   { name: '원숭이', emoji: '🐵', price: 0,    messages: ['좋아요!', '대단해!', '멋져요!'] },
    parrot:   { name: '앵무새', emoji: '🦜', price: 100,  messages: ['짹짹! 잘했어!', '날아올라!', '파이팅!'] },
    tiger:    { name: '호랑이', emoji: '🐯', price: 300,  messages: ['어흥! 최고야!', '용감해!', '으르렁!'] },
    elephant: { name: '코끼리', emoji: '🐘', price: 500,  messages: ['뿌우! 힘내!', '기억력 짱!', '잘한다!'] },
    lion:     { name: '사자',   emoji: '🦁', price: 800,  messages: ['왕의 실력!', '으하하!', '정글의 왕!'] },
    unicorn:  { name: '유니콘', emoji: '🦄', price: 1500, messages: ['마법같아!', '반짝반짝!', '무지개!'] },
    robot:    { name: '로봇',   emoji: '🤖', price: 1200, messages: ['계산 완료!', '비범해!', '삐리삐리!'] },
    panda:    { name: '팬더',   emoji: '🐼', price: 2000, messages: ['대나무 맛나!', '뒹굴뒹굴!', '느긋하게!'] },
    alien:    { name: '외계인', emoji: '👽', price: 2500, messages: ['우주급 실력!', '미지의 힘!', '텔레파시!'] },
    ghost:    { name: '유령',   emoji: '👻', price: 3000, messages: ['히히히!', '깜짝이야!', '보인다!'] },
    trex:     { name: '티라노', emoji: '🦖', price: 5000, messages: ['크아앙!', '최강 포식자!', '무적!'] }
};

const THEME_DEFS = {
    jungle: { name: '정글', emoji: '🌿', price: 0,   colors: null },
    ocean:  { name: '바다 탐험', emoji: '🌊', price: 200, colors: { primary: '200 80% 50%', secondary: '180 70% 45%', gradient: 'linear-gradient(135deg, #0077b6, #00b4d8, #90e0ef)' } },
    sakura: { name: '벚꽃 마을', emoji: '🌸', price: 300, colors: { primary: '330 70% 65%', secondary: '280 60% 60%', gradient: 'linear-gradient(135deg, #ffb7c5, #e0aaff, #ffc8dd)' } },
    desert: { name: '사막 모험', emoji: '🏜️', price: 400, colors: { primary: '30 80% 55%', secondary: '45 90% 50%', gradient: 'linear-gradient(135deg, #e6a057, #f0c27f, #fceabb)' } },
    space:  { name: '별빛 우주', emoji: '🌙', price: 500, colors: { primary: '260 70% 55%', secondary: '220 80% 40%', gradient: 'linear-gradient(135deg, #1a1a2e, #16213e, #0f3460)' } },
    choco:  { name: '초코 랜드', emoji: '🍫', price: 600, colors: { primary: '25 60% 40%', secondary: '340 70% 60%', gradient: 'linear-gradient(135deg, #5d4037, #8d6e63, #ffccbc)' } },
    ice:    { name: '얼음 왕국', emoji: '❄️', price: 700, colors: { primary: '190 90% 60%', secondary: '200 80% 80%', gradient: 'linear-gradient(135deg, #a8dadc, #457b9d, #f1faee)' } },
    volcano:{ name: '화산 지대', emoji: '🌋', price: 800, colors: { primary: '0 80% 50%', secondary: '30 90% 50%', gradient: 'linear-gradient(135deg, #d00000, #ffba08, #370617)' } },
    magic:  { name: '마법의 성', emoji: '🏰', price: 1000, colors: { primary: '270 70% 50%', secondary: '50 90% 60%', gradient: 'linear-gradient(135deg, #7b2cbf, #c77dff, #e0aaff)' } }
};

const TITLE_DEFS = [
    { id: 'first_clear', name: '수학 새싹', icon: '🌱', desc: '첫 스테이지 클리어', check: s => s.totalCorrect >= 5 },
    { id: 'add_master', name: '덧셈의 달인', icon: '➕', desc: '덧셈 50개 정답', check: s => s.addCorrect >= 50 },
    { id: 'sub_warrior', name: '뺄셈 전사', icon: '➖', desc: '뺄셈 50개 정답', check: s => s.subCorrect >= 50 },
    { id: 'mult_master', name: '구구단 마스터', icon: '✖️', desc: '곱셈 100개 정답', check: s => s.multCorrect >= 100 },
    { id: 'div_doctor', name: '나눗셈 박사', icon: '➗', desc: '나눗셈 100개 정답', check: s => s.divCorrect >= 100 },
    { id: 'genius', name: '수학 천재', icon: '🧠', desc: '총 1000문제 정답', check: s => s.totalCorrect >= 1000 },
    { id: 'speed', name: '빛의 속도', icon: '⚡', desc: '타이머 55초 이상 남기고 정답', check: s => s.fastAnswer >= 1 },
    { id: 'perfectionist', name: '완벽주의자', icon: '💎', desc: '힌트 없이 스테이지 클리어', check: s => s.noHintClears >= 1 },
    { id: 'streak', name: '철인', icon: '🔥', desc: '연속 10문제 정답', check: s => s.streakMax >= 10 },
    { id: 'explorer', name: '탐험가', icon: '🗺️', desc: '모든 단계 스테이지1 클리어', check: (s, p) => [1,2,3,4].every(g => (p[g]||0) >= 1) },
    { id: 'conqueror', name: '정복자', icon: '👑', desc: '한 단계 10스테이지 전부 클리어', check: (s, p) => Object.values(p).some(v => v >= 10) },
    { id: 'legend', name: '전설의 모험가', icon: '🌟', desc: '모든 단계 전 스테이지 클리어', check: (s, p) => [1,2,3,4].every(g => (p[g]||0) >= 10) },
    { id: 'shopper', name: '쇼핑의 왕', icon: '🛒', desc: '캐릭터 3개 구매', check: s => s.charsBought >= 3 },
    { id: 'fashionista', name: '패셔니스타', icon: '👗', desc: '테마 3개 구매', check: s => s.themesBought >= 3 },
    { id: 'max_level', name: '만렙 달성', icon: '⭐', desc: '캐릭터 1개 Lv.5 달성', check: s => s.maxCharLevel >= 5 }
];

const LEVEL_THRESHOLDS = [0, 50, 150, 300, 500];
const LEVEL_BONUSES = [
    { coinMult: 1.0, hintDelay: 3000, desc: '' },
    { coinMult: 1.0, hintDelay: 2000, desc: '힌트 대기시간 단축!' },
    { coinMult: 1.2, hintDelay: 2000, desc: '코인 1.2배!' },
    { coinMult: 1.5, hintDelay: 1000, desc: '코인 1.5배 + 힌트 초고속!' },
    { coinMult: 2.0, hintDelay: 1000, desc: '코인 2배! 전설 달성!' }
];

// --- Literacy Data ---
const LITERACY_DATA = {
    1: [
        {
            id: 'g1_s1',
            title: "토끼와 거북이",
            content: "옛날 옛적에 토끼와 거북이가 살았어요.\n토끼는 자기가 세상에서 가장 빠르다고 자랑했지요.\n\"나랑 경주할 친구 없니? 내가 다 이길 수 있어!\"\n느림보 거북이가 엉금엉금 기어와서 말했어요.\n\"나랑 경주하자, 토끼야.\"\n토끼는 껄껄 웃으며 승락했답니다.\n\n경주가 시작되자마자 토끼는 쌩~ 하고 달려나갔어요.\n한참을 가다가 뒤를 돌아보니 거북이는 보이지도 않았지요.\n\"흥, 내가 이긴 거나 다름없어. 낮잠이나 자야지.\"\n토끼는 나무 그늘 아래서 쿨쿨 잠이 들었어요.\n\n그 사이 거북이는 땀을 뻘뻘 흘리며 쉬지 않고 걸었어요.\n잠에서 깬 토끼가 결승선을 보니, 이미 거북이가 도착해 있었답니다.\n\"야호! 내가 이겼다!\" 거북이가 기뻐하며 소리쳤어요.",
            questions: [
                { q: "누가 달리기 경주를 제안했나요?", a: "거북이", options: ["토끼", "거북이", "사자"] },
                { q: "토끼는 경주 도중에 무엇을 했나요?", a: "낮잠을 잤다", options: ["열심히 달렸다", "낮잠을 잤다", "간식을 먹었다"] },
                { q: "누가 경주에서 이겼나요?", a: "거북이", options: ["토끼", "거북이", "무승부"] },
                { q: "이 이야기의 교훈은 무엇일까요?", a: "꾸준히 노력하면 이긴다", options: ["잠을 많이 자야 한다", "빨리 달리는 게 최고다", "꾸준히 노력하면 이긴다"] }
            ]
        },
        {
            id: 'g1_s2',
            title: "금도끼 은도끼",
            content: "어느 산골 마을에 착한 나무꾼이 살았어요.\n하루는 나무꾼이 연못가에서 나무를 하다가 그만 도끼를 풍덩 빠뜨리고 말았지요.\n\"아이고, 내 도끼! 이 도끼가 없으면 일을 할 수 없는데...\"\n나무꾼이 엉엉 울고 있을 때, 연못에서 산신령이 나타났어요.\n\n산신령은 번쩍이는 금도끼를 들고 물었어요.\n\"이 금도끼가 네 도끼냐?\"\n\"아닙니다. 제 도끼는 아주 낡은 쇠도끼입니다.\"\n산신령은 이번에는 은도끼를 들고 물었어요.\n\"그럼 이 은도끼가 네 도끼냐?\"\n\"아닙니다. 그것도 제 것이 아닙니다.\"\n\n마지막으로 산신령은 낡은 쇠도끼를 보여주었어요.\n\"그럼 이 쇠도끼가 네 도끼냐?\"\n\"네, 맞습니다! 그게 바로 제 도끼입니다!\"\n산신령은 나무꾼의 정직함에 감동하여 금도끼와 은도끼를 모두 선물로 주었답니다.",
            questions: [
                { q: "나무꾼이 잃어버린 물건은 무엇인가요?", a: "쇠도끼", options: ["금도끼", "은도끼", "쇠도끼"] },
                { q: "누가 연못에서 나타났나요?", a: "산신령", options: ["호랑이", "산신령", "선녀"] },
                { q: "나무꾼은 왜 금도끼를 자기 것이 아니라고 했나요?", a: "정직해서", options: ["바보라서", "정직해서", "금도끼가 싫어서"] },
                { q: "산신령은 나무꾼에게 무엇을 선물로 주었나요?", a: "금도끼와 은도끼", options: ["쇠도끼만", "금도끼만", "금도끼와 은도끼"] }
            ]
        },
        {
            id: 'g1_s3',
            title: "해님 달님",
            content: "옛날에 홀로 된 어머니가 오누이를 키우고 있었어요.\n어머니는 잔칫집 일을 도와주고 떡을 얻어 집으로 돌아오고 있었지요.\n그런데 고개 너머에서 커다란 호랑이가 나타났어요.\n\"어흥! 떡 하나 주면 안 잡아먹지!\"\n어머니는 떡을 다 주었지만, 욕심쟁이 호랑이는 어머니까지 잡아먹고 말았어요.\n\n호랑이는 어머니 옷을 입고 오누이가 있는 집으로 갔어요.\n\"얘들아, 엄마 왔다 문 열어라.\"\n영리한 오누이는 호랑이의 거친 손을 보고 문을 열어주지 않고 뒤뜰로 도망쳤어요.\n오누이는 나무 위로 올라가 하늘에 빌었어요.\n\"하느님, 저희를 살려주시려거든 튼튼한 동아줄을 내려주세요!\"\n하늘에서 내려온 동아줄을 타고 오누이는 하늘로 올라가 해님과 달님이 되었답니다.",
            questions: [
                { q: "호랑이가 어머니에게 요구한 것은?", a: "떡", options: ["돈", "떡", "옷"] },
                { q: "오누이는 어디로 도망쳤나요?", a: "나무 위", options: ["장독대", "나무 위", "지하실"] },
                { q: "오누이는 무엇을 타고 하늘로 올라갔나요?", a: "동아줄", options: ["엘리베이터", "동아줄", "구름"] },
                { q: "오누이는 하늘로 올라가 무엇이 되었나요?", a: "해님과 달님", options: ["별님과 구름", "해님과 달님", "천사"] }
            ]
        },
        {
            id: 'g1_s4',
            title: "콩쥐 팥쥐",
            content: "마음씨 착한 콩쥐는 새엄마와 팥쥐에게 구박을 받으며 살았어요.\n어느 날, 마을 원님 잔치가 열렸는데 새엄마는 콩쥐에게 힘든 일을 잔뜩 시키고 팥쥐와 먼저 가버렸지요.\n\"독에 물 채우기, 벼 찧기, 베 짜기를 다 끝내야 갈 수 있어.\"\n콩쥐가 울고 있을 때 두꺼비가 나타나 깨진 독을 막아주고, 참새들이 날아와 벼를 찧어주었어요.\n선녀님은 예쁜 옷과 꽃신을 주었답니다.\n\n잔치에 가던 콩쥐는 그만 꽃신 한 짝을 잃어버렸어요.\n나중에 원님이 그 꽃신 주인을 찾았는데, 팥쥐 발에는 맞지 않고 콩쥐 발에 꼭 맞았지요.\n원님은 콩쥐의 착한 마음씨에 반해 결혼해서 행복하게 살았답니다.",
            questions: [
                { q: "콩쥐를 괴롭힌 사람은 누구인가요?", a: "새엄마와 팥쥐", options: ["두꺼비", "원님", "새엄마와 팥쥐"] },
                { q: "깨진 독을 막아준 동물은?", a: "두꺼비", options: ["참새", "두꺼비", "소"] },
                { q: "콩쥐가 잃어버린 물건은?", a: "꽃신", options: ["지갑", "꽃신", "반지"] },
                { q: "결국 콩쥐는 누구와 결혼했나요?", a: "원님", options: ["나무꾼", "원님", "왕자님"] }
            ]
        },
        {
            id: 'g1_s5',
            title: "흥부와 놀부",
            content: "옛날에 욕심쟁이 형성 놀부와 착한 동생 흥부가 살았어요.\n놀부는 부모님의 재산을 다 차지하고 흥부를 쫓아냈지요.\n가난한 흥부는 어느 날 다리 다친 제비를 치료해 주었어요.\n\n이듬해 봄, 제비는 흥부에게 박씨 하나를 물어다 주었어요.\n박씨를 심으니 커다란 박이 주렁주렁 열렸지요.\n흥부 가족이 박을 타자 금은보화가 쏟아져 나와 부자가 되었답니다.\n이 소식을 들은 놀부도 제비 다리를 일부러 부러뜨리고 고쳐주어 박씨를 얻었어요.\n하지만 놀부의 박에서는 도깨비와 똥물이 나와 벌을 받았답니다.",
            questions: [
                { q: "흥부가 치료해 준 동물은?", a: "제비", options: ["까치", "제비", "참새"] },
                { q: "제비는 흥부에게 무엇을 주었나요?", a: "박씨", options: ["금덩이", "박씨", "보석"] },
                { q: "흥부네 박에서 나온 것은?", a: "금은보화", options: ["도깨비", "금은보화", "돌덩이"] },
                { q: "놀부는 왜 벌을 받았나요?", a: "제비 다리를 일부러 부러뜨려서", options: ["착하게 살아서", "제비 다리를 일부러 부러뜨려서", "박을 안 심어서"] }
            ]
        },
        {
            id: 'g1_s6',
            title: "선녀와 나무꾼",
            content: "어느 날 나무꾼이 사냥꾼에게 쫓기던 사슴을 숨겨주었어요.\n사슴은 고마워하며 선녀들이 목욕하는 연못을 알려주었지요.\n\"선녀 옷 한 벌을 감추면 선녀와 결혼할 수 있어요.\"\n나무꾼은 사슴 말대로 날개옷을 감추어 선녀와 결혼해 아이 둘을 낳고 살았어요.\n\n그러던 어느 날, 나무꾼은 선녀에게 날개옷을 보여주고 말았어요.\n선녀는 날개옷을 입자마자 아이들을 안고 하늘로 올라가 버렸답니다.\n나무꾼은 사슴의 도움으로 하늘로 올라가 선녀를 다시 만났지만,\n어머니가 그리워 다시 땅으로 내려오다 다시는 하늘로 돌아가지 못했답니다.",
            questions: [
                { q: "나무꾼에게 은혜를 갚은 동물은?", a: "사슴", options: ["토끼", "사슴", "곰"] },
                { q: "나무꾼이 감춘 물건은?", a: "날개옷", options: ["지갑", "날개옷", "신발"] },
                { q: "선녀는 날개옷을 입고 어디로 갔나요?", a: "하늘나라", options: ["이웃 마을", "하늘나라", "바닷속"] },
                { q: "나무꾼은 결국 어떻게 되었나요?", a: "땅에 남게 되었다", options: ["하늘에서 살았다", "사슴이 되었다", "땅에 남게 되었다"] }
            ]
        },
        {
            id: 'g1_s7',
            title: "호랑이와 곶감",
            content: "어느 깊은 산속 오두막에 호랑이가 어슬렁거리고 있었어요.\n방 안에서는 아이가 울고 있었지요.\n\"자꾸 울면 호랑이가 잡아간다!\" 엄마가 말했지만 아이는 계속 울었어요.\n호랑이는 자기가 온 걸 어떻게 알았나 깜짝 놀랐지요.\n\n그때 엄마가 \"옛다, 곶감이다!\" 하니 아이가 울음을 뚝 그쳤어요.\n호랑이는 '곶감이란 놈은 나보다 훨씬 무서운 놈이구나!' 하고 겁을 먹었어요.\n그때 소를 훔치러 온 도둑이 호랑이를 소인 줄 알고 등에 올라탔어요.\n호랑이는 곶감이 탄 줄 알고 필사적으로 도망쳤고, 도둑은 호랑이인 줄 알고 살려달라고 빌었답니다.",
            questions: [
                { q: "아이가 울음을 그친 이유는?", a: "곶감을 주어서", options: ["호랑이가 와서", "곶감을 주어서", "장난감을 주어서"] },
                { q: "호랑이는 무엇을 가장 무서워했나요?", a: "곶감", options: ["사냥꾼", "곶감", "할머니"] },
                { q: "호랑이 등에 탄 사람은?", a: "소 도둑", options: ["나무꾼", "소 도둑", "원님"] },
                { q: "호랑이는 도둑을 무엇이라 생각했나요?", a: "곶감", options: ["귀신", "곶감", "사람"] }
            ]
        },
        {
            id: 'g1_s8',
            title: "효녀 심청",
            content: "심청이는 앞을 못 보는 아버지 심봉사를 모시고 살았어요.\n어느 날 심봉사는 공양미 삼백 석을 바치면 눈을 뜰 수 있다는 말을 들었어요.\n효심 깊은 심청이는 아버지를 위해 뱃사람들에게 팔려가 인당수에 몸을 던졌지요.\n\n하지만 용왕님은 심청이의 효심에 감동하여 연꽃에 태워 다시 세상으로 보냈어요.\n연꽃에서 나온 심청이는 왕비가 되었답니다.\n왕비가 된 심청이는 아버지를 찾기 위해 맹인 잔치를 열었어요.\n잔치에 온 심봉사는 죽은 줄 알았던 딸을 만나자 너무 놀라 눈을 번쩍 뜨게 되었답니다.",
            questions: [
                { q: "심청이의 아버지는 어떤 분인가요?", a: "앞을 못 보는 맹인", options: ["아주 부자", "앞을 못 보는 맹인", "임금님"] },
                { q: "심청이는 아버지를 위해 무엇을 했나요?", a: "인당수에 몸을 던졌다", options: ["돈을 많이 벌었다", "인당수에 몸을 던졌다", "도망갔다"] },
                { q: "심청이는 다시 살아나 무엇이 되었나요?", a: "왕비", options: ["선녀", "왕비", "거지"] },
                { q: "심봉사는 어떻게 눈을 떴나요?", a: "딸을 만나 놀라서", options: ["약을 먹어서", "수술을 해서", "딸을 만나 놀라서"] }
            ]
        },
        {
            id: 'g1_s9',
            title: "의좋은 형제",
            content: "옛날에 아주 사이좋은 형제가 살았어요.\n가을이 되어 추수를 마친 형제는 곡식 단을 나누어 가졌지요.\n형은 '아우는 새로 살림을 났으니 더 필요할 거야'라며 밤에 몰래 아우네 볏단에 자기 볏단을 옮겨 놓았어요.\n아우는 '형님은 식구가 많으니 더 필요할 거야'라며 밤에 몰래 형님네 볏단에 자기 볏단을 옮겨 놓았어요.\n\n다음 날 아침, 형제는 볏단이 줄어들지 않은 것을 보고 이상하게 여겼어요.\n그날 밤도 서로 볏단을 나르다가 길 한가운데서 딱 마주쳤지요.\n형제는 서로를 얼싸안고 감동의 눈물을 흘렸답니다.",
            questions: [
                { q: "형제는 곡식을 어떻게 나누었나요?", a: "똑같이 나누었다가 몰래 더 주려고 했다", options: ["서로 더 가지려고 싸웠다", "똑같이 나누었다가 몰래 더 주려고 했다", "형이 다 가졌다"] },
                { q: "형은 왜 아우에게 볏단을 주려고 했나요?", a: "새 살림이라 돈이 필요해서", options: ["형이 부자라서", "새 살림이라 돈이 필요해서", "볏단이 싫어서"] },
                { q: "아우는 왜 형에게 볏단을 주려고 했나요?", a: "식구가 많아서", options: ["식구가 많아서", "형이 무서워서", "볏단이 무거워서"] },
                { q: "마지막에 형제는 어떻게 했나요?", a: "서로 안고 감동했다", options: ["싸웠다", "서로 안고 감동했다", "모르는 척했다"] }
            ]
        },
        {
            id: 'g1_s10',
            title: "개미와 베짱이",
            content: "무더운 여름날, 개미들은 땀을 뻘뻘 흘리며 먹이를 모으고 있었어요.\n하지만 베짱이는 나무 그늘에 앉아 노래만 부르며 놀았지요.\n\"개미야, 그렇게 일만 하지 말고 나랑 같이 노래하자.\"\n\"아니, 겨울을 준비해야 해.\"\n베짱이는 개미를 비웃으며 계속 놀기만 했어요.\n\n어느덧 찬 바람이 불고 겨울이 왔어요.\n들판에는 먹을 것이 하나도 없었지요.\n배가 고파 추위에 떨던 베짱이는 개미네 집 문을 두드렸어요.\n개미들은 베짱이를 따뜻하게 맞아주고 먹을 것도 나누어 주었답니다.\n베짱이는 그제야 자신의 게으름을 후회했답니다.",
            questions: [
                { q: "여름에 개미들은 무엇을 했나요?", a: "열심히 일했다", options: ["노래했다", "낮잠 잤다", "열심히 일했다"] },
                { q: "베짱이는 여름에 무엇을 했나요?", a: "노래 부르며 놀았다", options: ["일했다", "여행 갔다", "노래 부르며 놀았다"] },
                { q: "겨울이 되자 베짱이는 어떻게 되었나요?", a: "배고프고 추웠다", options: ["행복했다", "배고프고 추웠다", "부자가 되었다"] },
                { q: "이 이야기의 교훈은?", a: "미리미리 준비하자", options: ["놀 때가 제일 좋다", "겨울이 싫다", "미리미리 준비하자"] }
            ]
        },
        {
            id: 'g1_s11',
            title: "시골 쥐와 서울 쥐",
            content: "시골 쥐의 초대로 서울 쥐가 시골에 놀러 왔어요.\n시골 쥐는 콩과 옥수수를 대접했지만, 서울 쥐는 맛이 없다며 불평했지요.\n\"서울 우리 집에 가면 맛있는 케이크와 고기가 잔뜩 있어. 같이 가자!\"\n\n서울 쥐네 집 식탁에는 정말 맛있는 음식이 가득했어요.\n하지만 음식을 먹으려 할 때마다 사람들이 들어오거나 고양이가 나타나 도망쳐야 했어요.\n시골 쥐는 벌벌 떨며 말했어요.\n\"나는 맛있는 음식을 먹으며 불안하게 사는 것보다, 소박한 음식을 먹어도 마음 편히 사는 게 좋아.\"\n시골 쥐는 뒤도 안 돌아보고 시골로 돌아갔답니다.",
            questions: [
                { q: "서울 쥐가 시골 음식에 대해 한 말은?", a: "맛이 없다고 불평했다", options: ["아주 맛있다고 했다", "맛이 없다고 불평했다", "더 달라고 했다"] },
                { q: "서울 쥐네 집의 문제점은?", a: "위험하고 불안하다", options: ["음식이 없다", "위험하고 불안하다", "너무 조용하다"] },
                { q: "시골 쥐가 깨달은 것은?", a: "마음 편한 게 최고다", options: ["돈이 최고다", "마음 편한 게 최고다", "서울이 최고다"] },
                { q: "시골 쥐는 어디로 갔나요?", a: "시골로 돌아갔다", options: ["서울에 남았다", "다른 나라로 갔다", "시골로 돌아갔다"] }
            ]
        },
        {
            id: 'g1_s12',
            title: "양치기 소년",
            content: "양을 치던 심심한 소년이 마을 사람들을 향해 소리쳤어요.\n\"늑대다! 늑대가 나타났다!\"\n마을 사람들은 몽둥이를 들고 달려왔지만, 늑대는 없었고 소년이 깔깔 웃고 있었지요.\n소년은 몇 번이나 거짓말로 마을 사람들을 속였어요.\n\n그러던 어느 날, 진짜 늑대가 나타났어요.\n\"늑대다! 진짜 늑대가 나타났다! 살려주세요!\"\n소년은 목이 터져라 외쳤지만, 마을 사람들은 아무도 오지 않았어요.\n\"또 거짓말이겠지. 이번엔 안 속아.\"\n결국 양들은 모두 늑대에게 잡혀먹히고 말았답니다.",
            questions: [
                { q: "소년은 왜 거짓말을 했나요?", a: "심심해서", options: ["양을 지키려고", "심심해서", "늑대가 좋아서"] },
                { q: "마을 사람들은 왜 소년을 도와주지 않았나요?", a: "거짓말쟁이라서", options: ["바빠서", "거짓말쟁이라서", "귀가 안 들려서"] },
                { q: "진짜 늑대가 나타났을 때 어떤 일이 일어났나요?", a: "아무도 오지 않았다", options: ["모두가 도와주었다", "아무도 오지 않았다", "소년이 늑대를 이겼다"] },
                { q: "이 이야기의 교훈은?", a: "거짓말을 하면 안 된다", options: ["늑대는 무섭다", "양치기는 힘들다", "거짓말을 하면 안 된다"] }
            ]
        },
        {
            id: 'g1_s13',
            title: "아기 돼지 삼형제",
            content: "아기 돼지 삼형제가 집을 짓기로 했어요.\n첫째는 지푸라기로 대충, 둘째는 나무로 적당히 집을 지었지요.\n하지만 셋째는 벽돌로 튼튼하게 집을 지었어요.\n\n어느 날 늑대가 나타나 \"후~\" 하고 입김을 불자 첫째와 둘째의 집은 날아가 버렸어요.\n형들은 셋째네 벽돌집으로 도망쳤지요.\n늑대가 아무리 입김을 불어봐도 벽돌집은 끄떡없었어요.\n화가 난 늑대는 굴뚝으로 들어오려다 셋째가 끓여놓은 뜨거운 물에 퐁당 빠지고 말았답니다.",
            questions: [
                { q: "셋째 돼지는 무엇으로 집을 지었나요?", a: "벽돌", options: ["지푸라기", "나무", "벽돌"] },
                { q: "늑대가 집을 무너뜨린 방법은?", a: "입김을 불어서", options: ["발로 차서", "입김을 불어서", "불을 질러서"] },
                { q: "늑대가 들어가지 못한 집은?", a: "셋째의 벽돌집", options: ["첫째의 집", "둘째의 집", "셋째의 벽돌집"] },
                { q: "늑대는 결국 어떻게 되었나요?", a: "뜨거운 물에 빠졌다", options: ["돼지를 잡아먹었다", "친구가 되었다", "뜨거운 물에 빠졌다"] }
            ]
        },
        {
            id: 'g1_s14',
            title: "잭과 콩나무",
            content: "잭은 소를 팔러 갔다가 콩 다섯 알과 바꿨어요.\n화가 난 엄마는 콩을 창밖으로 던져버렸지요.\n다음 날 아침, 콩나무가 하늘까지 자라 있었어요.\n잭은 콩나무를 타고 올라가 거인의 성에 도착했답니다.\n\n잭은 거인 몰래 황금 알을 낳는 거위와 스스로 연주하는 하프를 가지고 도망쳤어요.\n잠에서 깬 거인이 쫓아오자, 잭은 서둘러 땅으로 내려와 도끼로 콩나무를 찍어버렸어요.\n\"쾅!\" 거인은 땅으로 떨어져 죽고, 잭과 엄마는 행복하게 살았답니다.",
            questions: [
                { q: "잭은 소를 무엇과 바꿨나요?", a: "콩 다섯 알", options: ["돈", "콩 다섯 알", "과자"] },
                { q: "콩나무는 어디까지 자랐나요?", a: "하늘까지", options: ["지붕까지", "하늘까지", "우주까지"] },
                { q: "잭이 거인의 성에서 가져온 것은?", a: "황금 알 낳는 거위", options: ["보석 상자", "황금 알 낳는 거위", "마법 지팡이"] },
                { q: "잭은 쫓아오는 거인을 어떻게 물리쳤나요?", a: "콩나무를 잘라서", options: ["마법을 써서", "돌을 던져서", "콩나무를 잘라서"] }
            ]
        },
        {
            id: 'g1_s15',
            title: "인어공주",
            content: "바닷속에 사는 인어공주는 왕자님을 사랑하게 되었어요.\n인어공주는 마녀에게 아름다운 목소리를 주고 사람의 다리를 얻었지요.\n하지만 왕자님의 사랑을 얻지 못하면 물거품이 되어야 했어요.\n\n왕자님은 인어공주가 자신을 구해주었다는 걸 모르고 이웃 나라 공주와 결혼을 약속했어요.\n언니들이 칼을 주며 왕자를 찌르면 다시 인어가 될 수 있다고 했지만,\n인어공주는 왕자를 너무 사랑해서 그럴 수 없었어요.\n결국 인어공주는 바다에 몸을 던져 공기 요정이 되었답니다.",
            questions: [
                { q: "인어공주는 무엇을 주고 다리를 얻었나요?", a: "목소리", options: ["머리카락", "목소리", "눈"] },
                { q: "인어공주가 왕자와 결혼하지 못하면 어떻게 되나요?", a: "물거품이 된다", options: ["돌이 된다", "물거품이 된다", "마녀가 된다"] },
                { q: "인어공주는 왜 왕자를 찌르지 못했나요?", a: "사랑해서", options: ["무서워서", "사랑해서", "칼이 없어서"] },
                { q: "이야기의 마지막에 인어공주는 무엇이 되었나요?", a: "공기 요정", options: ["사람", "물고기", "공기 요정"] }
            ]
        },
        {
            id: 'g1_s16',
            title: "미운 아기 오리",
            content: "어느 농장에서 아기 오리들이 태어났어요.\n그런데 마지막에 태어난 오리는 털이 회색이고 몸집도 커서 '미운 오리'라고 놀림을 받았어요.\n\"너는 왜 그렇게 못생겼니? 저리 가!\"\n미운 오리는 형제들과 친구들에게 따돌림을 당하다 결국 집을 떠났어요.\n\n추운 겨울을 힘들게 보낸 미운 오리는 봄이 되어 호수에서, 물에 비친 자신의 모습을 보았어요.\n그런데 이게 웬일일까요?\n그 못생긴 오리는 사실 아름다운 백조였답니다.\n백조가 된 미운 오리는 하늘을 날아올라 행복하게 살았어요.",
            questions: [
                { q: "미운 오리는 왜 놀림을 받았나요?", a: "생김새가 달라서", options: ["노래를 못해서", "생김새가 달라서", "밥을 많이 먹어서"] },
                { q: "미운 오리는 결국 어떻게 했나요?", a: "집을 떠났다", options: ["계속 참았다", "싸웠다", "집을 떠났다"] },
                { q: "미운 오리의 진짜 정체는 무엇이었나요?", a: "백조", options: ["독수리", "백조", "거위"] },
                { q: "이 이야기의 교훈은?", a: "겉모습만 보고 판단하지 말자", options: ["친구를 놀리면 안 된다", "겉모습만 보고 판단하지 말자", "오리는 귀엽다"] }
            ]
        },
        {
            id: 'g1_s17',
            title: "빨간 모자",
            content: "빨간 모자가 할머니 댁에 심부름을 가고 있었어요.\n숲속에서 만난 늑대는 빨간 모자를 속여 꽃을 꺾게 하고 먼저 할머니 댁으로 달려갔어요.\n늑대는 할머니를 잡아먹고 할머니 변장을 하고 누워 있었지요.\n\n빨간 모자가 도착하자 늑대는 빨간 모자까지 꿀꺽 삼켜버렸어요.\n그때 지나가던 사냥꾼이 코 골며 자는 늑대를 발견했지요.\n사냥꾼이 늑대의 배를 가르자 할머니와 빨간 모자가 무사히 나왔어요.\n그들은 늑대 배에 돌을 채워 넣었고, 잠에서 깬 늑대는 목이 말라 우물에 가다 빠져 죽었답니다.",
            questions: [
                { q: "빨간 모자는 어디에 가던 길이었나요?", a: "할머니 댁", options: ["학교", "할머니 댁", "시장"] },
                { q: "늑대는 빨간 모자를 따돌리고 무엇을 했나요?", a: "할머니를 잡아먹었다", options: ["잠을 잤다", "할머니를 잡아먹었다", "도망갔다"] },
                { q: "누가 빨간 모자와 할머니를 구해 주었나요?", a: "사냥꾼", options: ["나무꾼", "사냥꾼", "경찰"] },
                { q: "늑대의 최후는?", a: "우물에 빠졌다", options: ["도망갔다", "우물에 빠졌다", "사냥꾼이 되었다"] }
            ]
        },
        {
            id: 'g1_s18',
            title: "백설공주",
            content: "눈처럼 하얀 피부를 가진 백설공주는 마음씨 나쁜 새왕비의 질투를 받았어요.\n\"거울아, 거울아, 세상에서 누가 제일 예쁘니?\"\n\"백설공주입니다.\"\n화가 난 왕비는 사냥꾼을 시켜 공주를 없애려 했지만, 공주는 숲속으로 도망쳐 일곱 난쟁이들과 살게 되었어요.\n\n왕비는 독사가로 변장해 공주를 찾아가 사과를 먹였고 공주는 쓰러지고 말았어요.\n하지만 지나가던 이웃 나라 왕자님이 공주에게 키스하자 마법이 풀려 깨어났어요.\n두 사람은 결혼해서 행복하게 살았답니다.",
            questions: [
                { q: "왕비는 왜 백설공주를 미워했나요?", a: "예뻐서", options: ["착해서", "예뻐서", "부자라서"] },
                { q: "백설공주는 숲속에서 누구와 살았나요?", a: "일곱 난쟁이", options: ["요정", "일곱 난쟁이", "동물들"] },
                { q: "왕비가 백설공주에게 준 것은?", a: "독사과", options: ["독포도", "독사과", "독주스"] },
                { q: "백설공주는 어떻게 깨어났나요?", a: "왕자의 키스로", options: ["약으로", "왕자의 키스로", "시간이 지나서"] }
            ]
        },
        {
            id: 'g1_s19',
            title: "신데렐라",
            content: "신데렐라는 새엄마와 언니들에게 구박받으며 집안일을 도맡아 했어요.\n어느 날 왕궁에서 무도회가 열렸지만 신데렐라는 갈 수 없었지요.\n그때 요정 할머니가 나타나 호박 마차와 예쁜 드레스, 유리구두를 만들어 주었어요.\n\"밤 12시가 되면 마법이 풀리니 꼭 돌아와야 한다.\"\n\n무도회에서 왕자님과 춤을 추던 신데렐라는 12시가 되자 급히 나오다 유리구두 한 짝을 떨어뜨렸어요.\n왕자님은 그 구두의 주인을 찾아 온 나라를 다녔고, 마침내 신데렐라를 찾았답니다.\n신데렐라는 왕자님과 결혼해 행복하게 살았어요.",
            questions: [
                { q: "신데렐라에게 마법을 걸어준 사람은?", a: "요정 할머니", options: ["마녀", "요정 할머니", "새엄마"] },
                { q: "신데렐라가 꼭 지켜야 할 약속은?", a: "12시 전에 돌아오기", options: ["10시 전에 돌아오기", "12시 전에 돌아오기", "말하지 않기"] },
                { q: "신데렐라가 떨어뜨린 물건은?", a: "유리구두", options: ["장갑", "목걸이", "유리구두"] },
                { q: "이야기의 결말은?", a: "왕자와 결혼했다", options: ["계속 일했다", "왕자와 결혼했다", "도망갔다"] }
            ]
        },
        {
            id: 'g1_s20',
            title: "피노키오",
            content: "제페토 할아버지는 나무를 깎아 인형을 만들고 '피노키오'라고 이름 지었어요.\n요정은 피노키오에게 생명을 불어넣어 주었지요.\n\"착한 아이가 되면 진짜 사람이 될 수 있단다.\"\n하지만 피노키오는 학교에 가지 않고 서커스단에 가거나, 거짓말을 하곤 했어요.\n거짓말을 할 때마다 피노키오의 코는 길어졌지요.\n\n피노키오는 고래 뱃속에 갇힌 제페토 할아버지를 구하기 위해 용기를 내었어요.\n할아버지를 구하고 잘못을 뉘우친 피노키오는 마침내 진짜 사람이 되어 할아버지와 행복하게 살았답니다.",
            questions: [
                { q: "피노키오를 만든 사람은?", a: "제페토 할아버지", options: ["산타 할아버지", "제페토 할아버지", "목수 아저씨"] },
                { q: "피노키오가 거짓말을 하면 어떻게 되나요?", a: "코가 길어진다", options: ["다리가 길어진다", "코가 길어진다", "귀가 커진다"] },
                { q: "피노키오는 할아버지를 어디서 구했나요?", a: "고래 뱃속", options: ["동굴", "고래 뱃속", "감옥"] },
                { q: "마지막에 피노키오는 어떻게 되었나요?", a: "진짜 사람이 되었다", options: ["다시 나무가 되었다", "진짜 사람이 되었다", "장난감이 되었다"] }
            ]
        }
    ],
    2: [
        {
            id: 'g2_s1',
            title: "신호등이 있는 횡단보도",
            content: "길을 건널 때는 반드시 횡단보도를 이용해야 해요.\n신호등이 있는 횡단보도에서는 신호를 잘 지켜야 안전하답니다.\n\n빨간불일 때는 멈춰 서서 기다려야 해요.\n절대로 도로 안으로 들어가거나 장난을 치면 안 돼요.\n초록불로 바뀌면 좌우를 살피고 손을 들고 건너요.\n운전자가 나를 볼 수 있도록 손을 번쩍 드는 것이 좋아요.\n\n신호등이 깜빡거릴 때는 무리하게 건너지 말고 다음 신호를 기다려요.\n안전하게 길을 건너는 습관은 우리의 생명을 지켜주는 소중한 약속이에요.",
            questions: [
                { q: "길을 건널 때는 어디를 이용해야 하나요?", a: "횡단보도", options: ["차도", "횡단보도", "화단"] },
                { q: "빨간불일 때는 어떻게 해야 하나요?", a: "멈춰서 기다린다", options: ["빨리 뛰어간다", "천천히 건넌다", "멈춰서 기다린다"] },
                { q: "초록불에 건널 때 올바른 행동은?", a: "손을 들고 건넌다", options: ["춤을 추며 건넌다", "손을 들고 건넌다", "눈을 감고 건넌다"] },
                { q: "신호등이 깜빡거릴 때는 어떻게 해야 하나요?", a: "다음 신호를 기다린다", options: ["빨리 뛰어간다", "다음 신호를 기다린다", "천천히 걸어간다"] }
            ]
        },
        {
            id: 'g2_s2',
            title: "우리 몸에 좋은 물",
            content: "물은 우리 몸에서 아주 중요한 역할을 해요.\n우리 몸의 절반 이상은 물로 이루어져 있답니다.\n물은 우리가 먹은 음식물을 소화시키고, 몸 구석구석으로 영양분을 배달해 줘요.\n또 땀을 흘려 몸의 온도를 조절하고, 나쁜 노폐물을 몸 밖으로 내보내는 일도 하지요.\n\n하루에 물을 자주 마시는 것은 건강에 아주 좋아요.\n하지만 너무 차가운 물을 한꺼번에 많이 마시면 배탈이 날 수 있으니 조심해야 해요.\n건강을 위해 미지근한 물을 조금씩 자주 마시는 습관을 길러보아요!",
            questions: [
                { q: "우리 몸의 절반 이상은 무엇으로 이루어져 있나요?", a: "물", options: ["뼈", "근육", "물"] },
                { q: "물의 역할이 아닌 것은?", a: "키를 작게 만든다", options: ["영양분 배달", "체온 조절", "키를 작게 만든다"] },
                { q: "물을 마실 때 주의할 점은?", a: "너무 차가운 물 조심", options: ["너무 차가운 물 조심", "물 마시지 않기", "뜨거운 물만 마시기"] },
                { q: "건강하게 물을 마시는 방법은?", a: "미지근한 물을 자주", options: ["한꺼번에 많이", "미지근한 물을 자주", "자기 전에만"] }
            ]
        },
        {
            id: 'g2_s3',
            title: "올바른 양치질",
            content: "음식을 먹고 나면 이 사이에 음식물 찌꺼기가 남아요.\n그대로 두면 입안의 세균이 설탕을 먹고 이를 썩게 만들지요.\n그래서 식사 후 3분 안에 양치질을 하는 것이 중요해요.\n\n칫솔에 치약을 조금 묻혀 잇몸에서 치아 쪽으로 쓸어내리듯 닦아요.\n어금니 안쪽과 혀도 꼼꼼하게 닦아야 입 냄새가 나지 않아요.\n양치질이 끝나면 물로 입안을 깨끗이 헹궈야 해요.\n올바른 양치 습관으로 튼튼한 이를 지켜보아요!",
            questions: [
                { q: "양치질은 식사 후 언제 하는 것이 좋은가요?", a: "3분 안에", options: ["1시간 후에", "3분 안에", "자기 전에만"] },
                { q: "이를 닦는 올바른 방향은?", a: "잇몸에서 치아 쪽으로", options: ["옆으로만", "잇몸에서 치아 쪽으로", "아무렇게나"] },
                { q: "양치질할 때 닦아야 할 곳은?", a: "이와 혀 모두", options: ["이만", "혀만", "이와 혀 모두"] },
                { q: "양치질을 안 하면 생기는 문제는?", a: "이가 썩는다", options: ["이가 하얘진다", "이가 썩는다", "입맛이 좋아진다"] }
            ]
        },
        {
            id: 'g2_s4',
            title: "맛있는 김치",
            content: "김치는 우리나라를 대표하는 전통 음식이에요.\n배추나 무 같은 채소를 소금에 절이고 고춧가루, 마늘, 파 등으로 양념하여 발효시킨 것이지요.\n김치에는 유산균이 아주 많이 들어있어서 장 건강에 좋아요.\n\n옛날에는 겨울에 채소를 구하기 어려워 김장을 해서 땅속에 묻어두고 먹었어요.\n김치는 매콤하지만 감칠맛이 나고, 밥이나 라면과 함께 먹으면 꿀맛이에요.\n요즘은 외국 사람들도 김치를 아주 좋아한답니다.",
            questions: [
                { q: "김치는 어느 나라의 전통 음식인가요?", a: "우리나라", options: ["일본", "중국", "우리나라"] },
                { q: "김치에 많이 들어있는 좋은 균은?", a: "유산균", options: ["세균", "유산균", "곰팡이"] },
                { q: "옛날에는 김치를 어디에 보관했나요?", a: "땅속", options: ["냉장고", "땅속", "창고"] },
                { q: "김치의 주재료가 아닌 것은?", a: "초콜릿", options: ["배추", "무", "초콜릿"] }
            ]
        },
        {
            id: 'g2_s5',
            title: "태극기 이야기",
            content: "우리나라의 국기는 '태극기'라고 불러요.\n하얀색 바탕은 평화를 사랑하는 우리 민족의 마음을 나타내요.\n가운데 태극 문양의 빨강은 양(해), 파랑은 음(달)을 의미하며 우주의 조화를 상징해요.\n\n네 모서리의 4괘는 각각 하늘(건), 땅(곤), 물(감), 불(리)을 뜻한답니다.\n국경일에는 집집마다 태극기를 게양하여 나라 사랑하는 마음을 표현해요.\n태극기를 소중히 다루고 그 의미를 기억하는 어린이가 됩시다.",
            questions: [
                { q: "우리나라의 국기 이름은?", a: "태극기", options: ["성조기", "태극기", "오성홍기"] },
                { q: "태극기의 하얀 바탕은 무엇을 상징하나요?", a: "평화", options: ["용기", "평화", "부자"] },
                { q: "태극 문양은 무엇의 조화를 뜻하나요?", a: "우주", options: ["가족", "우주", "학교"] },
                { q: "태극기의 4괘가 뜻하지 않는 것은?", a: "나무", options: ["하늘", "땅", "나무"] }
            ]
        },
        {
            id: 'g2_s6',
            title: "무궁화 꽃이 피었습니다",
            content: "무궁화는 대한민국의 국화(나라 꽃)예요.\n'영원히 피고 또 피어서 지지 않는 꽃'이라는 뜻을 가지고 있지요.\n무궁화는 여름부터 가을까지 매일 새로운 꽃을 피워요.\n새벽에 피었다가 저녁이 되면 시들어 떨어지지만, 다음 날 다른 꽃봉오리가 또 피어나지요.\n\n은근와 끈기를 상징하는 무궁화는 우리 민족과 아주 닮았어요.\n애국가에도 '무궁화 삼천리 화려강산'이라는 구절이 나온답니다.",
            questions: [
                { q: "대한민국의 국화는?", a: "무궁화", options: ["장미", "무궁화", "해바라기"] },
                { q: "무궁화의 뜻은?", a: "영원히 피는 꽃", options: ["가장 예쁜 꽃", "영원히 피는 꽃", "가시가 있는 꽃"] },
                { q: "무궁화는 언제 피나요?", a: "새벽", options: ["밤", "새벽", "겨울"] },
                { q: "무궁화가 상징하는 것은?", a: "은근과 끈기", options: ["부와 명예", "은근과 끈기", "빠름"] }
            ]
        },
        {
            id: 'g2_s7',
            title: "사계절의 변화",
            content: "우리나라는 봄, 여름, 가을, 겨울 사계절이 뚜렷해요.\n봄에는 날씨가 따뜻해지고 예쁜 꽃들이 피어나요.\n여름은 덥고 비가 많이 오지만, 시원한 바다에서 물놀이를 할 수 있지요.\n가을은 하늘이 높고 푸르며 단풍이 붉게 물들고 맛있는 과일이 많이 열려요.\n겨울은 춥고 눈이 내리지만, 눈사람을 만들거나 썰매를 탈 수 있어 즐거워요.\n계절마다 달라지는 풍경은 정말 아름답답니다.",
            questions: [
                { q: "우리나라에는 몇 개의 계절이 있나요?", a: "4개", options: ["2개", "3개", "4개"] },
                { q: "꽃이 피는 계절은?", a: "봄", options: ["봄", "여름", "겨울"] },
                { q: "단풍이 들고 곡식을 거두는 계절은?", a: "가을", options: ["여름", "가을", "겨울"] },
                { q: "겨울에 할 수 있는 놀이는?", a: "눈사람 만들기", options: ["물놀이", "꽃구경", "눈사람 만들기"] }
            ]
        },
        {
            id: 'g2_s8',
            title: "시계 보는 법",
            content: "시계에는 짧은 바늘과 긴 바늘이 있어요.\n짧은 바늘은 '시'를, 긴 바늘은 '분'을 나타내요.\n짧은 바늘이 숫자 3을 가리키면 3시예요.\n\n긴 바늘이 숫자 12에 있으면 '정각', 숫자 6에 있으면 '30분'이에요.\n예를 들어 짧은 바늘이 3과 4 사이에 있고 긴 바늘이 6에 있다면 3시 30분이랍니다.\n1시간은 60분이고, 하루는 24시간이에요.\n시간을 볼 줄 알면 규칙적인 생활을 할 수 있답니다.",
            questions: [
                { q: "짧은 바늘은 무엇을 나타내나요?", a: "시", options: ["시", "분", "초"] },
                { q: "긴 바늘이 6에 있으면 몇 분인가요?", a: "30분", options: ["10분", "30분", "60분"] },
                { q: "1시간은 몇 분인가요?", a: "60분", options: ["30분", "60분", "100분"] },
                { q: "하루는 몇 시간인가요?", a: "24시간", options: ["12시간", "24시간", "10시간"] }
            ]
        },
        {
            id: 'g2_s9',
            title: "도서관에서의 예절",
            content: "도서관은 많은 사람이 책을 읽고 공부하는 곳이에요.\n그래서 도서관에서는 큰 소리로 떠들거나 뛰어다니면 안 돼요.\n책을 읽을 때는 조용히 페이지를 넘기고, 다 읽은 책은 제자리에 꽂아두거나 반납대에 놓아야 해요.\n\n도서관 책은 내 것이 아니므로 찢거나 낙서를 하면 안 된답니다.\n음식물을 먹으면 책이 더러워질 수 있으니 휴게실을 이용해요.\n모두가 규칙을 지킬 때 쾌적한 도서관이 될 수 있어요.",
            questions: [
                { q: "도서관에서 하면 안 되는 행동은?", a: "뛰어다니기", options: ["책 읽기", "조용히 걷기", "뛰어다니기"] },
                { q: "다 읽은 책은 어떻게 해야 하나요?", a: "제자리에 둔다", options: ["집에 가져간다", "제자리에 둔다", "바닥에 버린다"] },
                { q: "도서관 책에 낙서를 하면 안 되는 이유는?", a: "모두의 것이라서", options: ["종이가 아까워서", "모두의 것이라서", "펜이 없어서"] },
                { q: "도서관에서 지켜야 할 예절은?", a: "조용히 하기", options: ["노래 부르기", "음식 먹기", "조용히 하기"] }
            ]
        },
        {
            id: 'g2_s10',
            title: "불조심 해야 해요",
            content: "불은 우리 생활에 꼭 필요하지만, 잘못 다루면 무서운 화재가 날 수 있어요.\n성냥이나 라이터 같은 불장난은 절대로 하면 안 돼요.\n전기 코드를 문어발처럼 많이 꽂으면 과열되어 불이 날 수 있어요.\n\n불이 나면 \"불이야!\" 하고 크게 외치고 119에 신고해야 해요.\n연기가 나면 젖은 수건으로 코와 입을 막고 낮은 자세로 대피해요.\n소화기 사용법을 미리 익혀두면 작은 불을 끌 때 도움이 된답니다.",
            questions: [
                { q: "어린이가 절대로 하면 안 되는 것은?", a: "불장난", options: ["요리", "불장난", "숙제"] },
                { q: "불이 나면 가장 먼저 해야 할 일은?", a: "불이야 외치기", options: ["숨기", "불이야 외치기", "울기"] },
                { q: "대피할 때는 어떤 자세가 좋은가요?", a: "낮은 자세", options: ["서서 뛰기", "낮은 자세", "그냥 걷기"] },
                { q: "화재 신고 전화번호는?", a: "119", options: ["112", "119", "114"] }
            ]
        },
        {
            id: 'g2_s11',
            title: "쓰레기 분리수거",
            content: "우리가 버리는 쓰레기를 잘 분리하면 자원으로 다시 쓸 수 있어요.\n종이, 플라스틱, 유리, 캔은 재활용품으로 분류해서 버려야 해요.\n음식물 쓰레기는 동물 뼈나 조개껍데기를 제외하고 따로 모아야 해요.\n\n재활용이 안 되는 일반 쓰레기는 종량제 봉투에 담아 버립니다.\n분리수거를 잘하면 쓰레기 양도 줄이고 환경도 보호할 수 있어요.\n지구를 위해 분리수거를 생활화합시다!",
            questions: [
                { q: "재활용품이 아닌 것은?", a: "휴지", options: ["종이", "캔", "휴지"] },
                { q: "음식물 쓰레기로 버리면 안 되는 것은?", a: "조개껍데기", options: ["과일 껍질", "남은 밥", "조개껍데기"] },
                { q: "일반 쓰레기는 어디에 버리나요?", a: "종량제 봉투", options: ["아무 비닐", "종량제 봉투", "땅에 묻기"] },
                { q: "분리수거를 하는 이유는?", a: "환경 보호", options: ["귀찮게 하려고", "환경 보호", "봉투 팔려고"] }
            ]
        },
        {
            id: 'g2_s12',
            title: "시장과 마트",
            content: "우리는 필요한 물건을 사기 위해 시장이나 마트에 가요.\n시장은 야외에 있는 경우가 많고 상인들과 직접 이야기하며 물건을 살 수 있어요.\n\"깎아주세요\" 하고 흥정하는 재미도 있답니다.\n\n마트는 큰 건물 안에 여러 가지 물건이 종류별로 정리되어 있어요.\n카트를 밀며 편하게 쇼핑할 수 있고 가격이 정해져 있지요.\n시장과 마트 모두 우리 생활에 편리함을 주는 곳이랍니다.",
            questions: [
                { q: "시장의 특징은?", a: "흥정할 수 있다", options: ["카트가 있다", "가격표가 있다", "흥정할 수 있다"] },
                { q: "마트의 특징은?", a: "물건이 정리되어 있다", options: ["야외에 있다", "물건이 정리되어 있다", "주인이 없다"] },
                { q: "마트에서 물건을 담는 도구는?", a: "카트", options: ["지게", "카트", "배낭"] },
                { q: "시장과 마트는 무엇을 하는 곳인가요?", a: "물건을 사는 곳", options: ["공부하는 곳", "물건을 사는 곳", "잠자는 곳"] }
            ]
        },
        {
            id: 'g2_s13',
            title: "동물원의 동물들",
            content: "동물원에 가면 전 세계의 다양한 동물들을 만날 수 있어요.\n목이 긴 기린, 코가 긴 코끼리, 줄무늬 얼룩말 등 신기한 동물이 많지요.\n동물들을 구경할 때는 소리를 지르거나 유리를 두드리면 안 돼요.\n동물들이 스트레스를 받을 수 있기 때문이에요.\n아무 음식이나 던져주면 동물이 배탈이 날 수 있으니 조심해야 해요.\n동물을 사랑하는 마음으로 관람 예절을 지켜요.",
            questions: [
                { q: "목이 아주 긴 동물은?", a: "기린", options: ["하마", "기린", "사자"] },
                { q: "동물원에서 하면 안 되는 행동은?", a: "유리 두드리기", options: ["진지하게 보기", "사진 찍기", "유리 두드리기"] },
                { q: "동물에게 먹이를 함부로 주면 안 되는 이유는?", a: "배탈이 날까봐", options: ["배부를까봐", "배탈이 날까봐", "돈이 들어서"] },
                { q: "동물을 볼 때 어떤 마음을 가져야 하나요?", a: "사랑하는 마음", options: ["무서워하는 마음", "사랑하는 마음", "놀리는 마음"] }
            ]
        },
        {
            id: 'g2_s14',
            title: "바닷속 이야기",
            content: "바다 깊은 곳에는 수많은 생물들이 살고 있어요.\n물고기들은 아가미로 숨을 쉬고 지느러미로 헤엄을 쳐요.\n고래는 물고기처럼 생겼지만 새끼를 낳고 젖을 먹이는 포유류랍니다.\n\n문어와 오징어는 다리가 많고 먹물을 쏘아 적을 피해요.\n산호초는 알록달록 아름답지만 사실은 동물이에요.\n우리가 바다를 깨끗이 지켜야 이 많은 친구들이 건강하게 살 수 있답니다.",
            questions: [
                { q: "물고기는 무엇으로 숨을 쉬나요?", a: "아가미", options: ["허파", "아가미", "코"] },
                { q: "고래는 어떤 종류의 동물인가요?", a: "포유류", options: ["어류", "조류", "포유류"] },
                { q: "문어가 적을 피하는 방법은?", a: "먹물 쏘기", options: ["빨리 달리기", "먹물 쏘기", "소리 지르기"] },
                { q: "산호초는 식물일까요 동물일까요?", a: "동물", options: ["식물", "동물", "광물"] }
            ]
        },
        {
            id: 'g2_s15',
            title: "우주의 신비",
            content: "밤하늘을 올려다보면 수많은 별들이 반짝여요.\n우리가 사는 지구는 태양계 행성 중 하나랍니다.\n태양은 아주 뜨거운 불덩어리로 스스로 빛을 내는 별이에요.\n달은 지구 주위를 돌며 모양이 초승달, 반달, 보름달로 변하지요.\n우주에는 아직 우리가 모르는 신비한 비밀들이 가득하답니다.\n우주 비행사가 되어 우주를 탐험하는 꿈을 꿔보아요!",
            questions: [
                { q: "우리가 사는 행성의 이름은?", a: "지구", options: ["화성", "지구", "목성"] },
                { q: "스스로 빛을 내는 별은?", a: "태양", options: ["지구", "달", "태양"] },
                { q: "달의 모양이 둥그런 것은?", a: "보름달", options: ["초승달", "반달", "보름달"] },
                { q: "우주를 여행하는 사람은?", a: "우주 비행사", options: ["과학자", "우주 비행사", "선장"] }
            ]
        },
        {
            id: 'g2_s16',
            title: "곤충의 세계",
            content: "곤충은 머리, 가슴, 배 세 부분으로 나뉘고 다리가 6개예요.\n개미, 벌, 나비, 잠자리 등이 모두 곤충이지요.\n거미는 다리가 8개라서 곤충이 아니랍니다.\n\n곤충들은 생김새도 다양하고 사는 곳도 달라요.\n어떤 곤충은 보호색으로 몸을 숨기고, 어떤 곤충은 독침으로 자신을 지켜요.\n작지만 부지런히 살아가는 곤충들은 생태계에서 아주 중요한 역할을 해요.",
            questions: [
                { q: "곤충의 다리는 몇 개인가요?", a: "6개", options: ["4개", "6개", "8개"] },
                { q: "다음 중 곤충이 아닌 것은?", a: "거미", options: ["개미", "나비", "거미"] },
                { q: "곤충의 몸은 몇 부분으로 나뉘나요?", a: "3부분", options: ["2부분", "3부분", "4부분"] },
                { q: "곤충이 자신을 숨기는 방법은?", a: "보호색", options: ["투명망토", "보호색", "숨바꼭질"] }
            ]
        },
        {
            id: 'g2_s17',
            title: "공룡의 시대",
            content: "아주 아주 먼 옛날, 지구는 공룡들의 세상이었어요.\n티라노사우루스처럼 무서운 육식 공룡도 있었고,\n브라키오사우루스처럼 목이 긴 초식 공룡도 있었지요.\n트리케라톱스는 멋진 뿔을 가지고 있었어요.\n\n하지만 어느 날 갑작스러운 변화로 공룡들은 모두 사라지고 말았어요.\n지금은 화석을 통해 공룡들의 모습을 상상할 수 있지요.\n박물관에 가면 거대한 공룡 뼈를 볼 수 있답니다.",
            questions: [
                { q: "무서운 육식 공룡의 이름은?", a: "티라노사우루스", options: ["둘리", "티라노사우루스", "기린"] },
                { q: "목이 아주 긴 공룡은?", a: "브라키오사우루스", options: ["티라노사우루스", "트리케라톱스", "브라키오사우루스"] },
                { q: "공룡의 흔적을 알 수 있는 것은?", a: "화석", options: ["사진", "화석", "동영상"] },
                { q: "지금 공룡이 살아있나요?", a: "아니요", options: ["네", "아니요", "동물원에 있어요"] }
            ]
        },
        {
            id: 'g2_s18',
            title: "우리나라의 명절",
            content: "우리나라에는 설날과 추석이라는 큰 명절이 있어요.\n설날은 새해의 첫날로, 어른들께 세배를 드리고 떡국을 먹어요.\n윷놀이나 연날리기 같은 민속놀이도 하지요.\n\n추석은 곡식을 거두는 가을에 둥근 보름달을 보며 소원을 빌어요.\n송편을 빚어 먹고 조상님께 차례를 지내며 감사의 마음을 전해요.\n명절에는 온 가족이 모여 맛있는 음식을 먹고 즐거운 시간을 보낸답니다.",
            questions: [
                { q: "설날에 먹는 음식은?", a: "떡국", options: ["송편", "떡국", "미역국"] },
                { q: "추석에 먹는 음식은?", a: "송편", options: ["송편", "팥죽", "냉면"] },
                { q: "설날에 어른들께 하는 인사는?", a: "세배", options: ["악수", "세배", "포옹"] },
                { q: "추석에 뜨는 달은?", a: "보름달", options: ["초승달", "반달", "보름달"] }
            ]
        },
        {
            id: 'g2_s19',
            title: "한글의 우수성",
            content: "한글은 세종대왕님이 백성들을 위해 만든 글자예요.\n자음과 모음을 합쳐서 소리 나는 대로 적을 수 있는 과학적인 글자랍니다.\n'훈민정음'이라는 이름으로 세상에 처음 나왔지요.\n\n한글은 배우기 쉽고 쓰기도 편해서 누구나 자신의 생각을 글로 적을 수 있게 해주었어요.\n유네스코 세계기록유산에 등재될 만큼 자랑스러운 우리의 보물이랍니다.\n우리는 한글을 올바르게 사용하고 사랑해야 해요.",
            questions: [
                { q: "한글을 만든 분은?", a: "세종대왕", options: ["이순신", "세종대왕", "신사임당"] },
                { q: "한글의 원래 이름은?", a: "훈민정음", options: ["한자", "훈민정음", "알파벳"] },
                { q: "한글의 특징은?", a: "배우기 쉽다", options: ["어렵다", "그림이다", "배우기 쉽다"] },
                { q: "우리가 한글을 대하는 태도는?", a: "사랑하고 올바르게 쓴다", options: ["안 쓴다", "사랑하고 올바르게 쓴다", "바꿔 쓴다"] }
            ]
        },
        {
            id: 'g2_s20',
            title: "지구를 지켜요",
            content: "우리가 사는 지구는 점점 아파하고 있어요.\n공장에서 나오는 매연과 자동차 배기가스는 공기를 오염시켜요.\n우리가 버리는 플라스틱 쓰레기는 바다를 더럽히고 동물들을 아프게 해요.\n\n지구를 지키기 위해서는 우리 모두의 노력이 필요해요.\n가까운 거리는 걷고, 물과 전기를 아껴 써야 해요.\n일회용품 사용을 줄이고 나무를 많이 심는 것도 좋은 방법이에요.\n작은 실천이 모이면 아름다운 지구를 만들 수 있답니다.",
            questions: [
                { q: "지구를 오염시키는 것은?", a: "자동차 배기가스", options: ["나무", "자전거", "자동차 배기가스"] },
                { q: "우리가 줄여야 할 것은?", a: "일회용품", options: ["물", "일회용품", "나무"] },
                { q: "지구를 지키는 방법은?", a: "가까운 거리 걷기", options: ["쓰레기 버리기", "물 틀어놓기", "가까운 거리 걷기"] },
                { q: "지구를 왜 지켜야 하나요?", a: "우리가 살 곳이라서", options: ["우리가 살 곳이라서", "다른 별로 가려고", "심심해서"] }
            ]
        }
    ],
    // Fallback or future data can be added here
};

/* --- Game Engine --- */
class Game {
    constructor() {
        this.currentGrade = 0;
        this.currentStage = 0;
        this.score = 0;
        this.timer = 60;
        this.usedHintThisStage = false;
        
        this.timerInterval = null;
        this.maxQuestions = 5;
        this.currentQuestionCount = 0;
        this.currentProblem = null;
        this.currentProblem = null;
        this.hintLevel = 0;

        // Literacy State
        this.currentSubject = 'math'; // 'math' or 'literacy'
        this.literacyData = null;
        this.literacyQuestionIdx = 0;

        // UI References
        this.screens = {
            title: document.getElementById('screen-title'),
            map: document.getElementById('screen-map'),
            game: document.getElementById('screen-game'),
            result: document.getElementById('screen-result'),
            shop: document.getElementById('screen-shop'),
            titles: document.getElementById('screen-titles'),
            reading: document.getElementById('screen-reading')
        };
        
        this.els = {
            score: document.getElementById('score'),
            timer: document.getElementById('timer'),
            progressBar: document.getElementById('progress-fill'),
            problemText: document.getElementById('problem-text'),
            answerButtons: document.getElementById('answer-buttons'),
            hintArea: document.getElementById('hint-area'),
            btnHint: document.getElementById('btn-hint'),
            resultStars: document.getElementById('result-stars'),
            finalScore: document.getElementById('final-score-val'),
            stageList: document.getElementById('stage-list'),
            hintDrawer: document.getElementById('hint-drawer'),
            btnFold: document.getElementById('btn-fold-hint'),
            hudCoins: document.getElementById('hud-coins'),
            titleCoins: document.getElementById('title-coins'),
            titleChar: document.getElementById('title-character'),
            titleBadge: document.getElementById('title-badge'),
            playerChar: document.getElementById('player-char'),
            charLevelBadge: document.getElementById('char-level-badge'),
            charSpeech: document.getElementById('char-speech'),
            coinsEarned: document.getElementById('coins-earned'),
            expEarned: document.getElementById('exp-earned'),
            shopCoinDisplay: document.getElementById('shop-coin-display'),
            shopGrid: document.getElementById('shop-grid'),
            shopGrid: document.getElementById('shop-grid'),
            titlesGrid: document.getElementById('titles-grid'),
            
            // Literacy UI
            subjectBtns: document.querySelectorAll('.btn-subject'),
            screenReading: document.getElementById('screen-reading'),
            readingTitle: document.getElementById('reading-title'),
            readingText: document.getElementById('reading-text'),
            btnStartQuiz: document.getElementById('btn-start-quiz'),
            btnViewPassage: document.getElementById('btn-view-passage'),
            
            modalPassage: document.getElementById('modal-passage'),
            modalPassageTitle: document.getElementById('modal-passage-title'),
            modalPassageText: document.getElementById('modal-passage-text'),
            btnClosePassage: document.getElementById('btn-close-passage')
        };

        this.init();
    }

    init() {
        this.bindEvents();
        this.loadAllData();
        this.updateTitleScreen();
    }

    loadAllData() {
        // Stage Progress
        this.loadProgress();

        // Shop Data
        const shopSaved = localStorage.getItem('mathJungle_shop');
        if (shopSaved) {
            this.shopData = JSON.parse(shopSaved);
        } else {
            this.shopData = {
                coins: 0,
                characters: { monkey: { owned: true, level: 1, exp: 0 } },
                equippedChar: 'monkey',
                themes: { jungle: { owned: true } },
                equippedTheme: 'jungle'
            };
        }

        // Achievement Data
        const achSaved = localStorage.getItem('mathJungle_achievements');
        if (achSaved) {
            this.achData = JSON.parse(achSaved);
        } else {
            this.achData = {
                equippedTitle: null,
                unlocked: [],
                stats: {
                    totalCorrect: 0, addCorrect: 0, subCorrect: 0,
                    multCorrect: 0, divCorrect: 0,
                    streakCurrent: 0, streakMax: 0,
                    noHintClears: 0, fastAnswer: 0,
                    charsBought: 0, themesBought: 0, maxCharLevel: 1
                }
            };
        }
    }

    saveShopData() {
        localStorage.setItem('mathJungle_shop', JSON.stringify(this.shopData));
    }

    saveAchData() {
        localStorage.setItem('mathJungle_achievements', JSON.stringify(this.achData));
    }

    loadProgress() {
        const saved = localStorage.getItem('mathJungle_progress');
        let parsed = saved ? JSON.parse(saved) : null;
        
        // Migration: If old format (keys are numbers directly), wrap in 'math'
        if (parsed && !parsed.math && !parsed.literacy) {
             parsed = {
                 math: parsed,
                 literacy: { 1: 0, 2: 0, 3: 0, 4: 0 }
             };
             localStorage.setItem('mathJungle_progress', JSON.stringify(parsed));
        }

        if (!parsed) {
             parsed = {
                 math: { 1: 0, 2: 0, 3: 0, 4: 0 },
                 literacy: { 1: 0, 2: 0, 3: 0, 4: 0 }
             };
        }
        
        this.progress = parsed;
    }

    bindEvents() {
        // Grade Selection
        document.querySelectorAll('.btn-grade').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const grade = parseInt(e.currentTarget.dataset.grade);
                this.selectGrade(grade);
            });
        });

        // Map back button
        document.querySelector('#screen-map .btn-back').addEventListener('click', () => {
            this.showScreen('title');
            this.updateTitleScreen();
        });

        document.getElementById('btn-restart').addEventListener('click', () => {
            this.startGame(this.currentStage);
        });

        document.getElementById('btn-next').addEventListener('click', () => {
            this.startGame(this.currentStage + 1);
        });

        document.getElementById('btn-result-map').addEventListener('click', () => {
            this.showScreen('map');
            this.renderStageMap(this.currentGrade);
        });
        
        // Subject Toggle
        this.els.subjectBtns.forEach(btn => {
            btn.onclick = () => {
                this.currentSubject = btn.dataset.subject;
                this.updateSubjectUI();
            };
        });

        // Literacy Actions
        if (this.els.btnStartQuiz) this.els.btnStartQuiz.onclick = () => this.startLiteracyQuiz();
        if (this.els.btnViewPassage) this.els.btnViewPassage.onclick = () => this.togglePassageModal(true);
        if (this.els.btnClosePassage) this.els.btnClosePassage.onclick = () => this.togglePassageModal(false);
        
        // Resize Handler for Map Alignment
        window.addEventListener('resize', () => {
            if (!this.screens.map.classList.contains('hidden')) {
                if (this.resizeTimeout) clearTimeout(this.resizeTimeout);
                this.resizeTimeout = setTimeout(() => {
                    this.renderStageMap(this.currentGrade);
                }, 100);
            }
        });

        // Pause & Exit Handlers
        document.getElementById('btn-pause').addEventListener('click', () => this.togglePause(true));
        document.getElementById('btn-resume').addEventListener('click', () => this.togglePause(false));
        document.getElementById('btn-exit-map').addEventListener('click', () => this.exitToMap());
        document.getElementById('btn-exit-title').addEventListener('click', () => this.exitToTitle());
        
        // Hint Drawer
        // this.els.btnFold.addEventListener('click', () => this.toggleHintDrawer(false));
        
        // Hint System
        // this.els.btnHint.addEventListener('click', () => {
        //     if (this.hintLevel === 0) {
        //          this.showNextHint();
        //     } else {
        //          this.toggleHintDrawer(true);
        //     }
        // });

        // Shop Navigation
        document.getElementById('btn-open-shop').addEventListener('click', () => {
            this.showScreen('shop');
            this.renderShop('characters');
        });
        document.getElementById('btn-back-shop').addEventListener('click', () => {
            this.showScreen('title');
            this.updateTitleScreen();
        });

        // Titles Navigation
        document.getElementById('btn-open-titles').addEventListener('click', () => {
            this.showScreen('titles');
            this.renderTitlesScreen();
        });
        document.getElementById('btn-back-titles').addEventListener('click', () => {
            this.showScreen('title');
            this.updateTitleScreen();
        });

        // Shop Tabs
        document.querySelectorAll('.shop-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
                e.currentTarget.classList.add('active');
                this.renderShop(e.currentTarget.dataset.tab);
            });
        });

        // Level Up Modal Close
        document.getElementById('btn-close-levelup').addEventListener('click', () => {
            document.getElementById('modal-levelup').classList.add('hidden');
        });

        // Title Unlock Modal Close
        document.getElementById('btn-close-title-unlock').addEventListener('click', () => {
            document.getElementById('modal-title-unlock').classList.add('hidden');
        });
    }

    // Duplicate endGame removed from here


    toggleHintDrawer(show) {
        // if (show) {
        //     this.els.hintDrawer.classList.add('expanded');
        //     this.els.btnHint.classList.add('hidden');
        // } else {
        //     this.els.hintDrawer.classList.remove('expanded');
        //     this.els.btnHint.classList.remove('hidden');
        // }
    }

    selectGrade(grade) {
        console.log(`Selected Grade: ${grade}, Subject: ${this.currentSubject}`);
        this.currentGrade = grade;
        this.showScreen('map');
        
        // Force a small delay to ensure layout is ready
        setTimeout(() => {
            this.renderStageMap(grade);
        }, 50);
    }

    renderStageMap(grade) {
        console.log(`Rendering Stage Map for Grade ${grade}`);
        this.loadProgress(); // Ensure latest progress
        
        if (!this.els.stageList) {
            console.error("Stage list container not found!");
            return;
        }

        // ... (existing cleanup)
        this.els.stageList.innerHTML = '';
        this.els.stageList.className = 'stage-scroll-container';
        this.els.stageList.style = '';

        const container = this.els.stageList;
        const stages = 10;
        const verticalGap = 120;
        const waveWidth = 200;
        const startY = 50;
        
        // Get progress for this grade
        const subjectProgress = this.progress[this.currentSubject] || {};
        const maxCleared = subjectProgress[grade] || 0;
        
        // Create SVG
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("class", "map-path-svg");
        container.appendChild(svg);
        const coords = [];

        for(let i=1; i<=stages + 1; i++) {
            const btn = document.createElement('div');
            const rowIndex = i - 1;
            const xOffset = Math.sin(rowIndex * 0.8) * waveWidth; 
            const topPos = startY + (rowIndex * verticalGap);
            
            btn.className = 'stage-node';
            if (i > stages) btn.classList.add('infinite');
            
            // Locking Logic - Per Grade
            const isLocked = i > maxCleared + 1;
            if (isLocked) {
                btn.classList.add('locked');
                btn.innerHTML = "🔒";
            } else {
                 if (i <= stages) {
                    btn.innerText = i;
                    btn.onclick = () => {
                        console.log(`Starting Stage ${i}`);
                        this.startGame(i);
                    };
                } else {
                    btn.innerHTML = "✨<br>무한";
                    btn.onclick = () => {
                        console.log(`Starting Infinite Stage`);
                        this.startGame(11);
                    };
                }
            }

            btn.style.top = `${topPos}px`;
            // Fix centering logic - fallback to calculated center if clientWidth is 0
            const centerBase = container.clientWidth ? (container.clientWidth / 2) : (window.innerWidth / 2);
            btn.style.left = `calc(50% + ${xOffset}px - ${i > stages ? 50 : 40}px)`; 
            container.appendChild(btn);
            coords.push({ x: xOffset, y: topPos + (i > stages ? 50 : 40) });
        }
        
        // ... (SVG Path Generation code same as before)
        let pathD = "";
        const centerBase = container.clientWidth ? (container.clientWidth / 2) : (window.innerWidth / 2);
        
        coords.forEach((pos, idx) => {
            const realX = centerBase + pos.x;
            if (idx === 0) {
                pathD += `M ${realX} ${pos.y} `;
            } else {
                const prev = coords[idx-1];
                const prevX = centerBase + prev.x;
                const prevY = prev.y;
                const cp1x = prevX;
                const cp1y = prevY + (verticalGap / 2);
                const cp2x = realX;
                const cp2y = pos.y - (verticalGap / 2);
                pathD += `C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${realX} ${pos.y} `;
            }
        });

        const pathEl = document.createElementNS("http://www.w3.org/2000/svg", "path");
        pathEl.setAttribute("d", pathD);
        pathEl.setAttribute("stroke", "rgba(255,255,255,0.6)");
        pathEl.setAttribute("stroke-width", "10");
        pathEl.setAttribute("fill", "none");
        pathEl.setAttribute("stroke-dasharray", "20 10");
        pathEl.setAttribute("stroke-linecap", "round");
        svg.appendChild(pathEl);
        
        const totalHeight = startY + ((stages + 1) * verticalGap);
        svg.style.height = `${totalHeight}px`;
        
        const spacer = document.createElement('div');
        spacer.style.height = `${totalHeight + 100}px`;
        spacer.style.width = '1px';
        container.appendChild(spacer);
    }
    
    // ... (showScreen, startGame, startTimer, nextQuestion, checkAnswer, showNextHint, updateHUD, updateProgress)

    // Old endGame removed


    showScreen(screenName) {
        Object.values(this.screens).forEach(s => s.classList.remove('active', 'hidden'));
        Object.values(this.screens).forEach(s => s.classList.add('hidden'));
        
        const target = this.screens[screenName];
        target.classList.remove('hidden');
        setTimeout(() => target.classList.add('active'), 10);
    }

    startGame(stage) {
        this.currentStage = stage;
        this.score = 0;
        this.currentQuestionCount = 0;
        this.hintLevel = 0;
        this.usedHintThisStage = false;
        
        if (this.currentSubject === 'literacy') {
            this.startLiteracyMode(stage);
        } else {
            this.timer = this.getStageTimeLimit(this.currentGrade, stage);
            this.setupGameUI(); // Starts Math Game
        }
    }
    
    setupGameUI() {
        // Set equipped character
        const charId = this.shopData.equippedChar;
        const charDef = CHARACTER_DEFS[charId];
        const charData = this.shopData.characters[charId];
        this.els.playerChar.innerText = charDef.emoji;
        this.els.charLevelBadge.innerText = `Lv.${charData ? charData.level : 1}`;
        this.els.charSpeech.innerText = '';
        this.els.charSpeech.classList.remove('visible');

        this.els.charSpeech.classList.remove('visible');

        this.updateHUD();
        this.showScreen('game');

        // Toggle hint/passage buttons based on subject
        if (this.currentSubject === 'literacy') {
            this.els.btnHint.classList.add('hidden');
            this.els.btnViewPassage.classList.remove('hidden');
            this.updateLiteracyProgress(); // Initial progress for literacy
        } else {
            this.els.btnHint.classList.remove('hidden');
            this.els.btnViewPassage.classList.add('hidden');
            this.nextQuestion();
            this.startTimer();
        }
    }

    startTimer() {
        if(this.timerInterval) clearInterval(this.timerInterval);
        this.timerInterval = setInterval(() => {
            this.timer--;
            this.els.timer.innerText = this.timer;
            if(this.timer <= 0) {
                // Infinite Mode: Time Attack end is SUCCESS
                if (this.currentStage > 10) {
                    this.endGame(true);
                } else {
                    this.endGame(false);
                }
            }
        }, 1000);
    }

    getStageTimeLimit(grade, stage) {
        if (stage > 10) return 45; // Infinite mode base (Time Attack)
        
        if (grade === 1) return 60; // Counting
        
        if (grade === 2) {
            return stage <= 6 ? 60 : 80; // Add/Sub: 60s -> 80s
        }
        
        if (grade === 3) {
            return stage <= 4 ? 60 : 80; // Mult: 60s -> 80s
        }
        
        if (grade === 4) {
            return stage <= 4 ? 60 : 90; // Div: 60s -> 90s
        }
        
        return 60; // Default fallback
    }

    nextQuestion() {
        const isInfinite = this.currentStage > 10;
        if (!isInfinite && this.currentQuestionCount >= this.maxQuestions) {
            this.endGame(true);
            return;
        }

        this.currentQuestionCount++;
        this.updateProgress();
        this.hintLevel = 0;
        this.els.hintArea.innerHTML = '';
        this.toggleHintDrawer(false); // Close drawer
        this.els.btnHint.classList.add('hidden');
        
        // Generate Problem
        this.currentProblem = ProblemGenerator.generate(this.currentGrade, this.currentStage);
        
        // Render Problem
        this.els.problemText.innerHTML = `
            <div class="problem-desc">${this.currentProblem.desc}</div>
            <div class="problem-main">${this.currentProblem.problem}</div>
        `;
        
        // Render Options
        this.els.answerButtons.innerHTML = '';
        this.currentProblem.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn-option';
            btn.innerText = opt;
            btn.onclick = () => this.checkAnswer(opt, btn);
            this.els.answerButtons.appendChild(btn);
        });

        // Show Hint button after delay (based on character level)
        // const hintDelay = this.getHintDelay();
        // setTimeout(() => {
        //     this.els.btnHint.classList.remove('hidden');
        // }, hintDelay);
    }
    
    // Rename old method to specific Check Math Answer if needed, or dispatch in checkAnswer
    checkAnswer(selected, btnElement) {
        if (this.currentSubject === 'literacy') {
            this.checkLiteracyAnswer(selected, btnElement);
        } else {
            this.checkMathAnswer(selected, btnElement);
        }
    }

    checkMathAnswer(selected, btnElement) {
        if (selected === this.currentProblem.answer) {
            // Correct
            btnElement.style.background = '#4CAF50';
            btnElement.style.color = 'white';
            this.score += 100 + (this.timer * 2);
            this.playSound('correct');

            // Track stats
            this.achData.stats.totalCorrect++;
            this.achData.stats.streakCurrent++;
            if (this.achData.stats.streakCurrent > this.achData.stats.streakMax) {
                this.achData.stats.streakMax = this.achData.stats.streakCurrent;
            }
            if (this.timer >= 55) this.achData.stats.fastAnswer++;

            // Track operation type
            const h = this.currentProblem.hintData;
            if (h.type === 'calc' && h.op === '+') this.achData.stats.addCorrect++;
            if (h.type === 'calc' && h.op === '-') this.achData.stats.subCorrect++;
            if (h.type === 'mult') this.achData.stats.multCorrect++;
            if (h.type === 'div') this.achData.stats.divCorrect++;

            // Character speech
            this.showCharSpeech(true);

            // Add EXP
            this.addExp(1);
            this.saveAchData();

            setTimeout(() => this.nextQuestion(), 500);
        } else {
            // Incorrect
            btnElement.style.background = '#F44336';
            btnElement.style.color = 'white';
            this.achData.stats.streakCurrent = 0;
            this.shakeScreen();
            this.showNextHint();
            this.usedHintThisStage = true;
            this.showCharSpeech(false);
        }
        this.updateHUD();
    }

    showNextHint() {
        if (this.hintLevel >= 3) return;
        this.hintLevel++;
        this.toggleHintDrawer(true);
        
        const h = this.currentProblem.hintData;
        let hintHtml = '';
        
        // Helper for splitting tens/ones
        const getTens = (n) => Math.floor(n / 10) * 10;
        const getOnes = (n) => n % 10;

        // Check if it's a 2-digit calc (Grade 2 style)
        const isTwoDigit = h.type === 'calc' && h.v1 >= 10 && h.v2 >= 10;
        
        // --- Level 1: Visual / Concept ---
        if (this.hintLevel === 1) {
            if (isTwoDigit) {
                if (h.op === '+') {
                    hintHtml = `<div class="hint-text">십의 자리와 일의 자리를 나눠서 볼까요?</div>`;
                    hintHtml += `<div class="hint-group" style="flex-direction:column; gap:5px;">
                        <div>${h.v1} ➡ <span style="color:var(--primary);">${getTens(h.v1)}</span> 과 <span style="color:var(--accent);">${getOnes(h.v1)}</span></div>
                        <div>${h.v2} ➡ <span style="color:var(--primary);">${getTens(h.v2)}</span> 과 <span style="color:var(--accent);">${getOnes(h.v2)}</span></div>
                    </div>`;
                } else {
                    // Subtraction
                    const borrow = getOnes(h.v1) < getOnes(h.v2);
                    if (borrow) {
                        hintHtml = `<div class="hint-text">일의 자리끼리 뺄 수 없으니 빌려와요!</div>`;
                        hintHtml += `<div class="hint-group">${h.v1} ➡ <span style="color:var(--primary);">${getTens(h.v1)-10}</span> + <span style="color:var(--accent);">${getOnes(h.v1)+10}</span></div>`;
                    } else {
                        hintHtml = `<div class="hint-text">십의 자리와 일의 자리를 나눠서 볼까요?</div>`;
                        hintHtml += `<div class="hint-group" style="flex-direction:column; gap:5px;">
                            <div>${h.v1} ➡ ${getTens(h.v1)} 과 ${getOnes(h.v1)}</div>
                            <div>${h.v2} ➡ ${getTens(h.v2)} 과 ${getOnes(h.v2)}</div>
                        </div>`;
                    }
                }
            } else if (h.type === 'sequence') {
                hintHtml = `<div class="hint-text">숫자가 커지는 규칙을 찾아보세요!</div>`;
                hintHtml += `<div class="hint-group" style="margin-top:10px; font-size:1.5rem;">${h.values.join(' ➡ ')} ➡ ❓</div>`;
            } else if (h.type === 'calc') {
                // Single digit or simple
                if (h.op === '+') {
                    hintHtml = `<div class="hint-text">두 숫자를 더하면 몇 개가 될까요?</div>`;
                    hintHtml += `<div class="hint-group">
                        <span>🔵 x ${h.v1}</span> + <span>🔴 x ${h.v2}</span>
                    </div>`;
                } else {
                    hintHtml = `<div class="hint-text">${h.v1}개에서 ${h.v2}개를 빼면?</div>`;
                    hintHtml += `<div class="hint-group">
                        <span>🔵 x ${h.v1}</span> ➡ <span>❌ ${h.v2}개 지우기</span>
                    </div>`;
                }
            } else if (h.type === 'mult') {
                hintHtml = `<div class="hint-text">${h.table}개씩 ${h.step}묶음이 있어요!</div>`;
                hintHtml += `<div style="display:flex; flex-wrap:wrap; justify-content:center; gap:5px; margin-top:10px;">`;
                for(let i=0; i<h.step; i++) {
                    hintHtml += `<div class="hint-group" style="padding:5px;">${'🍎'.repeat(h.table)}</div>`;
                }
                hintHtml += `</div>`;
            } else if (h.type === 'div') {
                 hintHtml = `<div class="hint-text">${h.total}개를 ${h.perGroup}명에게 똑같이 나누어 주면?</div>`;
                 hintHtml += `<div class="hint-group" style="margin-top:10px;">🍪 ${h.total}개 준비!</div>`;
            }
        }
        
        // --- Level 2: Pattern / Meaning ---
        else if (this.hintLevel === 2) {
            if (isTwoDigit) {
                if (h.op === '+') {
                    const tenSum = getTens(h.v1) + getTens(h.v2);
                    const oneSum = getOnes(h.v1) + getOnes(h.v2);
                    hintHtml = `<div class="hint-text">끼리끼리 더해볼까요?</div>`;
                    hintHtml += `<div class="hint-group" style="flex-direction:column; gap:5px;">
                        <div>십의 자리: <span style="color:var(--primary);">${getTens(h.v1)} + ${getTens(h.v2)} = ${tenSum}</span></div>
                        <div>일의 자리: <span style="color:var(--accent);">${getOnes(h.v1)} + ${getOnes(h.v2)} = ${oneSum}</span></div>
                    </div>`;
                } else {
                    const borrow = getOnes(h.v1) < getOnes(h.v2);
                    if (borrow) {
                        const tens = getTens(h.v1) - 10;
                        const ones = getOnes(h.v1) + 10;
                        hintHtml = `<div class="hint-text">끼리끼리 빼볼까요?</div>`;
                        hintHtml += `<div class="hint-group" style="flex-direction:column; gap:5px;">
                            <div>십의 자리: ${tens} - ${getTens(h.v2)} = ${tens - getTens(h.v2)}</div>
                            <div>일의 자리: ${ones} - ${getOnes(h.v2)} = ${ones - getOnes(h.v2)}</div>
                        </div>`;
                    } else {
                        hintHtml = `<div class="hint-text">끼리끼리 빼볼까요?</div>`;
                        hintHtml += `<div class="hint-group" style="flex-direction:column; gap:5px;">
                            <div>십의 자리: ${getTens(h.v1)} - ${getTens(h.v2)} = ${getTens(h.v1) - getTens(h.v2)}</div>
                            <div>일의 자리: ${getOnes(h.v1)} - ${getOnes(h.v2)} = ${getOnes(h.v1) - getOnes(h.v2)}</div>
                        </div>`;
                    }
                }
            } else if (h.type === 'sequence') {
                hintHtml = `<div class="hint-text">숫자가 <strong>${h.step}</strong>씩 커지고 있어요!</div>`;
            } else if (h.type === 'calc') {
                hintHtml = `<div class="hint-text">손가락으로 세어볼까요?</div>
                            <div class="hint-group" style="font-size:1.2rem;">${h.v1} ${h.op} ${h.v2}</div>`;
            } else if (h.type === 'mult') {
                const addStr = Array(h.step).fill(h.table).join(" + ");
                hintHtml = `<div class="hint-text">덧셈으로 바꿔볼까요?</div>
                            <div class="hint-group" style="font-size:1.2rem;">${addStr}</div>`;
            } else if (h.type === 'div') {
                hintHtml = `<div class="hint-text">${h.perGroup}단 구구단을 외워볼까요?</div>
                            <div class="hint-group">${h.perGroup} x ❓ = ${h.total}</div>`;
            }
        }
        
        // --- Level 3: Near Answer ---
        else if (this.hintLevel === 3) {
            if (isTwoDigit) {
                 if (h.op === '+') {
                    const tenSum = getTens(h.v1) + getTens(h.v2);
                    const oneSum = getOnes(h.v1) + getOnes(h.v2);
                    hintHtml = `<div class="hint-text">이제 두 값을 합쳐보세요!</div>`;
                    hintHtml += `<div class="hint-group" style="font-size:1.5rem;">${tenSum} + ${oneSum} = ❓</div>`;
                 } else {
                    // Subtraction final step
                     hintHtml = `<div class="hint-text" style="background:var(--accent);">정답은 <strong>${h.answer}</strong> 입니다!</div>`;
                 }
            } else if (h.type === 'sequence') {
                hintHtml = `<div class="hint-text" style="background:var(--accent);">정답은 <strong>${h.values[h.values.length-1] + h.step}</strong> 입니다!</div>`;
            } else if (h.type === 'div') {
                hintHtml = `<div class="hint-text" style="background:var(--accent);">정답은 <strong>${h.answer}</strong> 입니다!</div>`;
            } else {
                let near = h.answer + (Math.random() > 0.5 ? 1 : -1);
                hintHtml = `<div class="hint-text" style="background:var(--accent);">정답은 <strong>${h.answer}</strong> 입니다!</div>`;
            }
        }

        this.els.hintArea.innerHTML = hintHtml;
    }



    updateHUD() {
        this.els.score.innerText = this.score;
        this.els.timer.innerText = this.timer;
        this.els.hudCoins.innerText = this.shopData.coins;
    }

    updateProgress() {
        const isInfinite = this.currentStage > 10;
        const pct = isInfinite ? 100 : (this.currentQuestionCount / this.maxQuestions) * 100;
        this.els.progressBar.style.width = `${pct}%`;
    }

    endGame(success) {
        clearInterval(this.timerInterval);
        this.showScreen('result');
        this.els.finalScore.innerText = this.score;
        
        let coinsGained = 0;
        let expGained = 0;

        if (success) {
            this.els.resultStars.innerText = "⭐⭐⭐";
            
            if (this.currentStage > 10) {
                document.querySelector('.result-title').innerText = "무한 도전 종료! 🔥";
                // Infinite mode: Retry button instead of Next
                document.getElementById('btn-next').style.display = 'none'; 
                // Maybe change "Next" button text to "Retry"? Or just hide it and rely on map/restart.
                // Actually, let's keep Next as "Replay" or hide it. 
                // Let's hide it for now as per "Time Attack" feel, user goes back to map or restarts.
                // Or better: Show a "Retry" button. For now, hiding 'btn-next' is safe.
            } else {
                document.querySelector('.result-title').innerText = "스테이지 클리어! 🎉";
                document.getElementById('btn-next').style.display = '';
            }

            this.playSound('correct');
            
            // Unlock Next Stage Logic
            // const currentMax = this.progress[this.currentGrade] || 0;
            const subjectProgress = this.progress[this.currentSubject] || {};
            const currentMax = subjectProgress[this.currentGrade] || 0;

            // Only unlock up to stage 10. Infinite stages (11+) are always open if 10 is cleared.
            if (this.currentStage <= 10 && this.currentStage > currentMax) {
                // this.progress[this.currentGrade] = this.currentStage;
                if (!this.progress[this.currentSubject]) this.progress[this.currentSubject] = {};
                this.progress[this.currentSubject][this.currentGrade] = this.currentStage;
                localStorage.setItem('mathJungle_progress', JSON.stringify(this.progress));
            }

            // Award coins (Enable for all stages, including infinite)
            const mult = this.getCoinMultiplier();
            coinsGained = Math.floor((this.score / 10) * mult);
            
            // Bonus for Infinite Mode (Optional: higher rewards for higher difficulty)
            if (this.currentStage > 10) {
                 coinsGained += Math.floor((this.currentStage - 10) * 10);
            }

            this.shopData.coins += coinsGained;
            this.saveShopData();

            // Award bonus EXP
            expGained = 5; // Stage clear bonus
            if (this.currentStage > 10) expGained += 2; // Extra EXP for infinite

            if (!this.usedHintThisStage) {
                expGained += 3;
                this.achData.stats.noHintClears++;
            }
            this.addExp(expGained);
            this.saveAchData();

            // Check title unlocks
            this.checkTitleUnlocks();
        } else {
            this.els.resultStars.innerText = "⭐";
            document.querySelector('.result-title').innerText = "시간 초과! 😢";
            document.getElementById('btn-next').style.display = 'none';
        }

        // Display earned rewards
        this.els.coinsEarned.innerText = `+${coinsGained}`;
        this.els.expEarned.innerText = success ? `+${expGained} EXP` : '';
    }

    shakeScreen() {
        this.screens.game.style.transform = "translateX(10px)";
        setTimeout(() => this.screens.game.style.transform = "translateX(-10px)", 50);
        setTimeout(() => this.screens.game.style.transform = "translateX(0)", 100);
    }
    
    playSound(type) {
        console.log(`Playing sound: ${type}`);
    }

    togglePause(pause) {
        const modal = document.getElementById('modal-pause');
        if (pause) {
            clearInterval(this.timerInterval);
            modal.classList.remove('hidden');
        } else {
            modal.classList.add('hidden');
            this.startTimer();
        }
    }

    exitToMap() {
        clearInterval(this.timerInterval);
        document.getElementById('modal-pause').classList.add('hidden');
        this.showScreen('map');
        this.renderStageMap(this.currentGrade);
    }

    exitToTitle() {
        clearInterval(this.timerInterval);
        document.getElementById('modal-pause').classList.add('hidden');
        this.showScreen('title');
        this.updateTitleScreen();
    }

    // --- Coin Multiplier ---
    getCoinMultiplier() {
        const charId = this.shopData.equippedChar;
        const charData = this.shopData.characters[charId];
        if (!charData) return 1.0;
        const lvl = Math.min(charData.level - 1, LEVEL_BONUSES.length - 1);
        return LEVEL_BONUSES[lvl].coinMult;
    }

    getHintDelay() {
        const charId = this.shopData.equippedChar;
        const charData = this.shopData.characters[charId];
        if (!charData) return 3000;
        const lvl = Math.min(charData.level - 1, LEVEL_BONUSES.length - 1);
        return LEVEL_BONUSES[lvl].hintDelay;
    }

    // --- Character Speech ---
    showCharSpeech(correct) {
        const charId = this.shopData.equippedChar;
        const charDef = CHARACTER_DEFS[charId];
        if (!charDef) return;

        const msgs = correct ? charDef.messages : ['다시 해보자!', '힘내!', '괜찮아!'];
        const msg = msgs[Math.floor(Math.random() * msgs.length)];
        this.els.charSpeech.innerText = msg;
        this.els.charSpeech.classList.add('visible');
        setTimeout(() => this.els.charSpeech.classList.remove('visible'), 1500);
    }

    // --- EXP / Leveling ---
    addExp(amount) {
        const charId = this.shopData.equippedChar;
        const charData = this.shopData.characters[charId];
        if (!charData) return;

        charData.exp += amount;
        const currentLevel = charData.level;

        // Check level up
        if (currentLevel < LEVEL_THRESHOLDS.length) {
            const nextThreshold = LEVEL_THRESHOLDS[currentLevel]; // next level threshold
            if (charData.exp >= nextThreshold) {
                charData.level++;
                this.saveShopData();

                // Update max level stat
                if (charData.level > this.achData.stats.maxCharLevel) {
                    this.achData.stats.maxCharLevel = charData.level;
                }

                // Show level up modal
                const charDef = CHARACTER_DEFS[charId];
                document.getElementById('levelup-icon').innerText = charDef.emoji;
                document.getElementById('levelup-text').innerText = `${charDef.name} Lv.${charData.level} 달성!`;
                const bonus = LEVEL_BONUSES[Math.min(charData.level - 1, LEVEL_BONUSES.length - 1)];
                document.getElementById('levelup-bonus').innerText = bonus.desc;
                document.getElementById('modal-levelup').classList.remove('hidden');

                // Update badge
                this.els.charLevelBadge.innerText = `Lv.${charData.level}`;
            }
        }
        this.saveShopData();
    }

    // --- Title Screen ---
    updateTitleScreen() {
        this.els.titleCoins.innerText = this.shopData.coins;
        const charDef = CHARACTER_DEFS[this.shopData.equippedChar];
        this.els.titleChar.innerText = charDef ? charDef.emoji : '🐵';

        if (this.achData.equippedTitle) {
            const title = TITLE_DEFS.find(t => t.id === this.achData.equippedTitle);
            this.els.titleBadge.innerText = title ? `${title.icon} ${title.name}` : '';
            this.els.titleBadge.style.display = 'inline-block';
        } else {
            this.els.titleBadge.innerText = '';
            this.els.titleBadge.style.display = 'none';
        }

        // Apply theme
        this.applyTheme(this.shopData.equippedTheme);
    }

    // --- Theme ---
    applyTheme(themeId) {
        const theme = THEME_DEFS[themeId];
        const root = document.documentElement;
        if (theme && theme.colors) {
            root.style.setProperty('--primary', theme.colors.primary);
            root.style.setProperty('--secondary', theme.colors.secondary);
            document.querySelector('.background-layer').style.background = theme.colors.gradient;
        } else {
            // Reset to default jungle
            root.style.setProperty('--primary', '130 60% 45%');
            root.style.setProperty('--secondary', '45 100% 55%');
            document.querySelector('.background-layer').style.background = '';
        }
    }

    // --- Shop ---
    renderShop(tab) {
        this.els.shopCoinDisplay.innerText = this.shopData.coins;
        const scrollPos = this.els.shopGrid.scrollTop;
        this.els.shopGrid.innerHTML = '';

        if (tab === 'characters') {
            Object.entries(CHARACTER_DEFS).forEach(([id, def]) => {
                const owned = this.shopData.characters[id]?.owned;
                const equipped = this.shopData.equippedChar === id;
                const charData = this.shopData.characters[id];
                const level = charData ? charData.level : 0;
                const canAfford = this.shopData.coins >= def.price;

                const card = document.createElement('div');
                card.className = `shop-card ${owned ? 'owned' : ''} ${equipped ? 'equipped' : ''} ${!owned && !canAfford ? 'locked' : ''}`;
                card.dataset.id = id;
                card.innerHTML = `
                    <div class="shop-card-emoji">${def.emoji}</div>
                    <div class="shop-card-name">${def.name}</div>
                    ${owned ? `<div class="shop-card-level">Lv.${level}</div>` : `<div class="shop-card-price">🪙 ${def.price}</div>`}
                    <button class="shop-card-btn">
                        ${equipped ? '✅ 착용 중' : owned ? '착용하기' : canAfford ? '구매하기' : '🔒 부족'}
                    </button>
                `;

                const btn = card.querySelector('.shop-card-btn');
                if (equipped) {
                    btn.disabled = true;
                } else if (owned) {
                    btn.addEventListener('click', () => this.equipCharacter(id));
                } else if (canAfford) {
                    btn.addEventListener('click', () => this.buyCharacter(id));
                } else {
                    btn.disabled = true;
                }

                this.els.shopGrid.appendChild(card);
            });
        } else {
            // Themes
            Object.entries(THEME_DEFS).forEach(([id, def]) => {
                const owned = this.shopData.themes[id]?.owned;
                const equipped = this.shopData.equippedTheme === id;
                const canAfford = this.shopData.coins >= def.price;

                const card = document.createElement('div');
                card.className = `shop-card theme-card ${owned ? 'owned' : ''} ${equipped ? 'equipped' : ''} ${!owned && !canAfford ? 'locked' : ''}`;
                card.dataset.id = id;
                
                // Theme preview
                let previewStyle = '';
                if (def.colors) {
                    previewStyle = `background: ${def.colors.gradient};`;
                } else {
                    previewStyle = 'background: linear-gradient(135deg, #2d5016, #4a7c23, #7bc74d);';
                }

                card.innerHTML = `
                    <div class="theme-preview" style="${previewStyle}"></div>
                    <div class="shop-card-emoji">${def.emoji}</div>
                    <div class="shop-card-name">${def.name}</div>
                    ${owned ? '' : `<div class="shop-card-price">🪙 ${def.price}</div>`}
                    <button class="shop-card-btn">
                        ${equipped ? '✅ 적용 중' : owned ? '적용하기' : canAfford ? '구매하기' : '🔒 부족'}
                    </button>
                `;

                const btn = card.querySelector('.shop-card-btn');
                if (equipped) {
                    btn.disabled = true;
                } else if (owned) {
                    btn.addEventListener('click', () => this.equipTheme(id));
                } else if (canAfford) {
                    btn.addEventListener('click', () => this.buyTheme(id));
                } else {
                    btn.disabled = true;
                }

                this.els.shopGrid.appendChild(card);
            });
        }
        this.els.shopGrid.scrollTop = scrollPos;
    }

    buyCharacter(id) {
        const def = CHARACTER_DEFS[id];
        if (this.shopData.coins < def.price) return;

        this.shopData.coins -= def.price;
        this.shopData.characters[id] = { owned: true, level: 1, exp: 0 };
        this.achData.stats.charsBought++;
        this.saveShopData();
        this.saveAchData();
        this.checkTitleUnlocks();
        this.renderShop('characters');
    }

    buyTheme(id) {
        const def = THEME_DEFS[id];
        if (this.shopData.coins < def.price) return;

        this.shopData.coins -= def.price;
        this.shopData.themes[id] = { owned: true };
        this.achData.stats.themesBought++;
        this.saveShopData();
        this.saveAchData();
        this.checkTitleUnlocks();
        this.renderShop('themes');
    }

    equipCharacter(id) {
        this.shopData.equippedChar = id;
        this.saveShopData();
        // In-place update instead of full re-render
        this.els.shopGrid.querySelectorAll('.shop-card').forEach(card => {
            const btn = card.querySelector('.shop-card-btn');
            if (card.dataset.id === id) {
                card.classList.add('equipped');
                btn.textContent = '✅ 착용 중';
                btn.disabled = true;
            } else {
                if (card.classList.contains('equipped')) {
                    card.classList.remove('equipped');
                    btn.textContent = '착용하기';
                    btn.disabled = false;
                    btn.onclick = () => this.equipCharacter(card.dataset.id);
                }
            }
        });
    }

    equipTheme(id) {
        this.shopData.equippedTheme = id;
        this.applyTheme(id);
        this.saveShopData();
        // In-place update instead of full re-render
        this.els.shopGrid.querySelectorAll('.shop-card').forEach(card => {
            const btn = card.querySelector('.shop-card-btn');
            if (card.dataset.id === id) {
                card.classList.add('equipped');
                btn.textContent = '✅ 적용 중';
                btn.disabled = true;
            } else {
                if (card.classList.contains('equipped')) {
                    card.classList.remove('equipped');
                    btn.textContent = '적용하기';
                    btn.disabled = false;
                    btn.onclick = () => this.equipTheme(card.dataset.id);
                }
            }
        });
    }

    // --- Titles ---
    renderTitlesScreen() {
        const scrollPos = this.els.titlesGrid.scrollTop;
        this.els.titlesGrid.innerHTML = '';

        // Unlocked titles first
        const unlocked = TITLE_DEFS.filter(t => this.achData.unlocked.includes(t.id));
        const locked = TITLE_DEFS.filter(t => !this.achData.unlocked.includes(t.id));

        if (unlocked.length > 0) {
            const header = document.createElement('h3');
            header.className = 'titles-section-header';
            header.innerText = '✨ 획득한 칭호';
            this.els.titlesGrid.appendChild(header);

            unlocked.forEach(t => {
                const isEquipped = this.achData.equippedTitle === t.id;
                const card = document.createElement('div');
                card.className = `title-card ${isEquipped ? 'equipped' : ''}`;
                card.dataset.id = t.id;
                card.innerHTML = `
                    <span class="title-icon">${t.icon}</span>
                    <div class="title-info">
                        <strong>${t.name}</strong>
                        <small>${t.desc}</small>
                    </div>
                    <button class="title-equip-btn">${isEquipped ? '✅ 착용 중' : '착용'}</button>
                `;
                if (!isEquipped) {
                    card.querySelector('.title-equip-btn').addEventListener('click', () => this.equipTitle(t.id));
                }
                this.els.titlesGrid.appendChild(card);
            });
        }

        if (locked.length > 0) {
            const header = document.createElement('h3');
            header.className = 'titles-section-header';
            header.innerText = '🔒 미획득';
            this.els.titlesGrid.appendChild(header);

            locked.forEach(t => {
                const card = document.createElement('div');
                card.className = 'title-card locked';
                card.innerHTML = `
                    <span class="title-icon">🔒</span>
                    <div class="title-info">
                        <strong>${t.name}</strong>
                        <small>${t.desc}</small>
                    </div>
                `;
                this.els.titlesGrid.appendChild(card);
            });
        }
        this.els.titlesGrid.scrollTop = scrollPos;
    }

    checkTitleUnlocks() {
        let newUnlocks = [];
        // Use math progress for titles for now, as most are designed for the 4-grade system
        // If we add literacy titles later, we can adjust this or pass the full object
        const progressToCheck = this.progress.math || { 1: 0, 2: 0, 3: 0, 4: 0 };
        
        TITLE_DEFS.forEach(t => {
            if (!this.achData.unlocked.includes(t.id)) {
                if (t.check(this.achData.stats, progressToCheck)) {
                    this.achData.unlocked.push(t.id);
                    newUnlocks.push(t);
                }
            }
        });

        if (newUnlocks.length > 0) {
            this.saveAchData();
            // Show first new title unlock
            const t = newUnlocks[0];
            document.getElementById('title-unlock-icon').innerText = t.icon;
            document.getElementById('title-unlock-text').innerText = `${t.icon} "${t.name}" — ${t.desc}`;
            document.getElementById('modal-title-unlock').classList.remove('hidden');
        }
    }

    equipTitle(id) {
        this.achData.equippedTitle = id;
        this.saveAchData();
        // In-place update instead of full re-render
        this.els.titlesGrid.querySelectorAll('.title-card').forEach(card => {
            const btn = card.querySelector('.title-equip-btn');
            if (!btn) return; // locked cards have no button
            if (card.dataset.id === id) {
                card.classList.add('equipped');
                btn.textContent = '✅ 착용 중';
                btn.disabled = true;
            } else {
                if (card.classList.contains('equipped')) {
                    card.classList.remove('equipped');
                    btn.textContent = '착용';
                    btn.disabled = false;
                    btn.onclick = () => this.equipTitle(card.dataset.id);
                }
            }
        });
    }
    // --- Literacy Methods ---

    updateSubjectUI() {
        this.els.subjectBtns.forEach(btn => {
            if (btn.dataset.subject === this.currentSubject) btn.classList.add('active');
            else btn.classList.remove('active');
        });

        const gradeTexts = document.querySelectorAll('.grade-text');
        const gradeBtns = document.querySelectorAll('.btn-grade');

        if (this.currentSubject === 'literacy') {
            gradeTexts[0].innerHTML = "동화 읽기<br>(1단계)";
            gradeTexts[1].innerHTML = "생활 상식<br>(2단계)";
            gradeTexts[2].innerHTML = "준비중<br>(3단계)";
            gradeTexts[3].innerHTML = "준비중<br>(4단계)";

            // Disable Grade 3 & 4
            if (gradeBtns[2]) {
                gradeBtns[2].style.pointerEvents = 'none';
                gradeBtns[2].style.opacity = '0.5';
            }
            if (gradeBtns[3]) {
                gradeBtns[3].style.pointerEvents = 'none';
                gradeBtns[3].style.opacity = '0.5';
            }

        } else {
            gradeTexts[0].innerHTML = "기초 탄탄<br>(수 세기)";
            gradeTexts[1].innerHTML = "덧셈 뺄셈<br>(연산)";
            gradeTexts[2].innerHTML = "구구단<br>(곱셈)";
            gradeTexts[3].innerHTML = "나눗셈<br>(심화)";

            // Enable all
            gradeBtns.forEach(btn => {
                btn.style.pointerEvents = '';
                btn.style.opacity = '';
            });
        }
    }

    startLiteracyMode(stage) {
        const gradeData = LITERACY_DATA[this.currentGrade] || LITERACY_DATA[1];
        // Cycle through stories safely
        const storyIndex = (stage - 1) % gradeData.length;
        this.literacyData = gradeData[storyIndex];
        this.literacyQuestionIdx = 0;
        
        this.showScreen('reading');
        this.els.readingTitle.innerText = this.literacyData.title;
        this.els.readingText.innerText = this.literacyData.content;
        
        // Bind back button for reading screen
        document.getElementById('btn-back-reading').onclick = () => {
            this.showScreen('map');
            this.renderStageMap(this.currentGrade);
        };
    }

    startLiteracyQuiz() {
        this.timer = 120; // More time for literacy
        this.setupGameUI();
        this.nextLiteracyQuestion();
        this.startTimer();
    }

    nextLiteracyQuestion() {
        // If we ran out of questions
        if (!this.literacyData.questions[this.literacyQuestionIdx]) {
            this.endGame(true);
            return;
        }

        const qData = this.literacyData.questions[this.literacyQuestionIdx];

        this.currentProblem = {
            answer: qData.a,
            options: qData.options
        };
        
        this.els.problemText.innerHTML = `
            <div class="problem-desc" style="font-size:1.4rem;">문제 ${this.literacyQuestionIdx + 1}</div>
            <div class="problem-main" style="font-size:1.8rem; line-height:1.4; white-space:pre-wrap;">${qData.q}</div>
        `;

        this.els.answerButtons.innerHTML = '';
        this.currentProblem.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'btn-option';
            btn.innerText = opt;
            btn.style.fontSize = "1.5rem"; // Smaller text
            btn.onclick = () => this.checkAnswer(opt, btn);
            this.els.answerButtons.appendChild(btn);
        });

        this.updateLiteracyProgress();
    }

    checkLiteracyAnswer(selected, btnElement) {
        if (selected === this.currentProblem.answer) {
             btnElement.style.background = '#4CAF50';
             btnElement.style.color = 'white';
             this.score += 200; 
             this.playSound('correct');
             this.showCharSpeech(true);
             
             this.literacyQuestionIdx++;
             setTimeout(() => this.nextLiteracyQuestion(), 800);
        } else {
             btnElement.style.background = '#F44336';
             btnElement.style.color = 'white';
             this.shakeScreen();
             this.showCharSpeech(false);
        }
        this.updateHUD();
    }

    updateLiteracyProgress() {
         const total = this.literacyData.questions.length;
         const pct = (this.literacyQuestionIdx / total) * 100;
         this.els.progressBar.style.width = `${pct}%`;
    }

    togglePassageModal(show) {
        if (show) {
            this.els.modalPassageTitle.innerText = this.literacyData.title;
            this.els.modalPassageText.innerText = this.literacyData.content;
            this.els.modalPassage.classList.remove('hidden');
        } else {
            this.els.modalPassage.classList.add('hidden');
        }
    }
}

// Initialize Game on Load
// Initialize Game on Load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        window.game = new Game();
    });
} else {
    window.game = new Game();
}
